(function(){var f,h,t,r,a,p,d,v,b,g,o,c,C,w,l,e,x,j,D,i,k,s,y,B,n,z,m,u,q={}.hasOwnProperty,A=function(H,F){for(var E in F){if(q.call(F,E)){H[E]=F[E]}}function G(){this.constructor=H}G.prototype=F.prototype;H.prototype=new G();H.__super__=F.prototype;return H};a=window.Cruddy||{};e="transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd";o="&mdash;";l=" / ";x=422;moment.lang([a.locale,"en"]);Backbone.emulateHTTP=true;Backbone.emulateJSON=true;$(document).ajaxSend(function(F,G,E){if(!a.app){E.displayLoading=false}if(E.displayLoading){a.app.startLoading()}G.setRequestHeader("X-CSRF-TOKEN",a.token)}).ajaxComplete(function(F,G,E){if(E.displayLoading){a.app.doneLoading()}});$(document.body).on("click","[data-trigger=fancybox]",function(E){if($.fancybox.open(E.currentTarget)!==false){return false}});$.extend($.fancybox.defaults,{openEffect:"elastic"});B=(function(E){return function(F){return F.replace(/_-/," ")}})(this);s=function(G,E){var F;F=a.baseUrl+"/"+G;if(E){F+="/"+E}return F};j=function(E){return setTimeout(E,50)};u=function(H,G,E){var F;F=""+a.thumbUrl+"?src="+(encodeURIComponent(H));if(G){F+="&amp;width="+G}if(E){F+="&amp;height="+E}return F};i=function(E){return"<span class='glyphicon glyphicon-"+E+"'></span>"};D=function(E,H,G,F){if(H==null){H=null}if(G==null){G="btn-default"}if(F==null){F="button"}if(H){E=i(H)+" "+E}if(_.isArray(G)){G="btn-"+G.join(" btn-")}return"<button type='"+F+"' class='btn "+G+"'>"+(E.trim())+"</button>"};n=function(){return'<li class="divider"></li>'};z=function(E,F){return'<li><a href="'+E+'" target="_blank">'+F+"</a></li>"};m=function(F){var E,G,H;G="";for(H in F){E=F[H];G+=z(E,H)}return G};k=function(E,F){if(E){return F}else{return""}};y=function(J,I){var F,H,E,G;if(I==null){I=window}if(_.isEmpty(J)){return I}G=J.split(".");for(H=0,E=G.length;H<E;H++){F=G[H];if(!(F in I)){return}I=I[F]}return I};h=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.tagName="span";E.prototype.className="alert";E.prototype.initialize=function(G){var H;this.$el.addClass((H=this.className+"-"+G.type)!=null?H:"info");this.$el.text(G.message);if(G.timeout!=null){setTimeout(((function(I){return function(){return I.remove()}})(this)),G.timeout)}return this};E.prototype.render=function(){j((function(G){return function(){return G.$el.addClass("show")}})(this));return this};E.prototype.remove=function(){this.$el.one(e,(function(G){return function(){return E.__super__.remove.apply(G,arguments)}})(this));this.$el.removeClass("show");return this};return E})(Backbone.View);v=(function(){function E(){}E.prototype.create=function(G,F){var H;H=this[G];if(H!=null){return new H(F)}console.error("Failed to resolve "+G+".");return null};return E})();$.extend(a,{Fields:{},Columns:{},Filters:{},formatters:new v,getHistoryRoot:function(){return this.baseUrl.substr(this.root.length)},getApp:function(){if(!this.app){this.app=(new t).init()}return this.app},ready:function(E){return this.getApp().ready(E)}});a.View=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.componentId=function(G){return this.cid+"-"+G};F.prototype.$component=function(G){return this.$("#"+this.componentId(G))};return F})(Backbone.View);f=(function(){function E(F){this.original=new FormData;if(F!=null){this.append(F)}}E.prototype.append=function(G,F){if(G===void 0){return}if(G instanceof File||G instanceof Blob){return this.original.append(F,G)}if(_.isObject(G)||_.isArray(G)){if(_.isEmpty(G)){return this.original.append(F,"")}_.each(G,(function(H){return function(J,I){return H.append(J,H.key(F,I))}})(this));return}return this.original.append(F,this.process(G))};E.prototype.process=function(F){if(F===null){return""}if(F===true){return 1}if(F===false){return 0}return F};E.prototype.key=function(G,F){if(G){return""+G+"["+F+"]"}else{return F}};return E})();a.Attribute=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G){this.entity=G.entity;return this};E.prototype.getType=function(){return"attribute"};E.prototype.getHelp=function(){return this.attributes.help};E.prototype.isVisible=function(){return this.attributes.hide===false};return E})(Backbone.Model);d=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.defaults={page:1,per_page:null,keywords:"",order_by:null,order_dir:"asc"};E.prototype.initialize=function(H,I){var G;this.entity=G=I.entity;this.defaults=_.clone(this.attributes);this.options={url:G.url(),dataType:"json",type:"get",displayLoading:true,success:(function(J){return function(K){J.resp=K;return J.trigger("data",J,K.items)}})(this),error:(function(J){return function(K){return J.trigger("error",J,K)}})(this)};this.on("change:keywords",(function(J){return function(){return J.set("page",1)}})(this));return this.on("change",(function(J){return function(L,K){if(!K.noFetch){return J.fetch()}}})(this))};E.prototype.hasData=function(){return this.resp!=null};E.prototype.isEmpty=function(){return !this.hasData()||_.isEmpty(this.resp.items)};E.prototype.hasMore=function(){return this.hasData()&&this.resp.page<this.resp.lastPage};E.prototype.isFull=function(){return !this.hasMore()};E.prototype.inProgress=function(){return this.request!=null};E.prototype.fetch=function(){if(this.request!=null){this.request.abort()}this.options.data=this._getRequestData();this.request=$.ajax(this.options);this.request.always((function(G){return function(){return G.request=null}})(this));this.trigger("request",this,this.request);return this.request};E.prototype.next=function(){if(this.inProgress()||this.isFull()){return}this.set({page:this.get("page")+1});return this};E.prototype.prev=function(){var G;if(this.inProgress()||(G=this.get("page"))<=1){return}this.set({page:G-1});return this};E.prototype._getRequestData=function(){var J,G,I,H;J={};H=this.attributes;for(G in H){I=H[G];if(_.isNumber(I)||!_.isEmpty(I)){J[G]=I}}return J};E.prototype.getData=function(){var G;return(G=this.resp)!=null?G.items:void 0};E.prototype.getTotal=function(){var G;return(G=this.resp)!=null?G.total:void 0};E.prototype.getFrom=function(){var G;return(G=this.resp)!=null?G.from:void 0};E.prototype.getTo=function(){var G;return(G=this.resp)!=null?G.to:void 0};E.prototype.getLastPage=function(){var G;return(G=this.resp)!=null?G.lastPage:void 0};return E})(Backbone.Model);w=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.defaults={keywords:null,constraint:null};E.prototype.initialize=function(G,H){this.resetData=false;this.needsRefresh=false;this.data=[];this.page=null;this.more=true;this.options={url:H.url,type:"get",dataType:"json",data:{simple:1},success:(function(I){return function(N){var K,M,J,L;if(I.resetData){I.data=[];I.resetData=false}L=N.items;for(M=0,J=L.length;M<J;M++){K=L[M];I.data.push(K)}I.page=N.page;I.more=N.page<N.lastPage;I.request=null;I.trigger("data",I,I.data);return I}})(this),error:(function(I){return function(J){I.request=null;I.trigger("error",I,J);return I}})(this)};if(H.ajaxOptions!=null){$.extend(true,this.options,H.ajaxOptions)}this.on("change",this.refresh,this);return this};E.prototype.refresh=function(){this.resetData=true;return this.fetchPage(1)};E.prototype.fetchPage=function(G){if(this.request!=null){this.request.abort()}$.extend(this.options.data,this.attributes,{page:G});this.trigger("request",this,this.request=$.ajax(this.options));return this.request};E.prototype.next=function(){this.fetchPage(this.page!=null?this.page+1:this.more?1:void 0);return this};E.prototype.inProgress=function(){return this.request!=null};E.prototype.isEmpty=function(){return this.page===null&&!this.request};E.prototype.getById=function(G){if(!G.length){G=G.toString()}return _.find(this.data,function(H){return H.id.toString()===G})};return E})(Backbone.Model);c=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.tagName="ul";F.prototype.className="pager";F.prototype.events={"click a":"navigate"};F.prototype.initialize=function(H){var G;G=a.router;this.listenTo(this.model,"data",this.render);this.listenTo(this.model,"request",this.disable);$(document).on("keydown.pagination",$.proxy(this,"hotkeys"));return this};F.prototype.hotkeys=function(G){if(G.ctrlKey&&G.keyCode===37){this.previous();return false}if(G.ctrlKey&&G.keyCode===39){this.next();return false}return this};F.prototype.page=function(G){if(G>0&&G<=this.model.getLastPage()){this.model.set("page",G)}return this};F.prototype.previous=function(){return this.page(this.model.get("page")-1)};F.prototype.next=function(){return this.page(this.model.get("page")+1)};F.prototype.navigate=function(G){G.preventDefault();if(!this.model.inProgress()){return this.page($(G.target).data("page"))}};F.prototype.disable=function(){this.$("a").addClass("disabled");return this};F.prototype.render=function(){var G;if(this.model.hasData()){G=this.model.getLastPage();this.$el.toggle((G!=null)&&G>1);if(G>1){this.$el.html(this.template(this.model.get("page"),G))}}return this};F.prototype.template=function(I,H){var G;G="";G+=this.renderLink(I-1,"&larr; "+a.lang.prev,"previous"+(I>1?"":" disabled"));if(this.model.getTotal()!=null){G+=this.renderStats()}G+=this.renderLink(I+1,""+a.lang.next+" &rarr;","next"+(I<H?"":" disabled"));return G};F.prototype.renderStats=function(){return'<li class="stats"><span>'+(this.model.getFrom())+" - "+(this.model.getTo())+" / "+(this.model.getTotal())+"</span></li>"};F.prototype.renderLink=function(I,G,H){if(H==null){H=""}return'<li class="'+H+'"><a href="#" data-page="'+I+'">'+G+"</a></li>"};return F})(Backbone.View);p=(function(F){A(E,F);E.prototype.tagName="table";E.prototype.className="table table-hover dg";E.prototype.events={"click .col__sortable":"setOrder","click [data-action]":"executeAction"};function E(G){this.className+=" dg-"+G.entity.id;E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G){this.entity=G.entity;this.columns=this.entity.columns.models.filter(function(H){return H.isVisible()});this.addActionColumns(this.columns);this.listenTo(this.model,"data",(function(H){return function(){if(H.$items!=null){return H.renderBody()}}})(this));this.listenTo(this.model,"change:order_by change:order_dir",this.markOrderColumn);return this.listenTo(this.entity,"change:instance",this.markActiveItem)};E.prototype.addActionColumns=function(G){this.columns.unshift(new a.Columns.ViewButton({entity:this.entity}));if(this.entity.deletePermitted()){this.columns.push(new a.Columns.DeleteButton({entity:this.entity}))}return this};E.prototype.markOrderColumn=function(){var H,G;H=this.model.get("order_by");G=this.model.get("order_dir")||"asc";if((this.orderBy!=null)&&H!==this.orderBy){this.$colCell(this.orderBy).removeClass("asc desc")}this.$colCell(this.orderBy=H).removeClass("asc desc").addClass(G);return this};E.prototype.markActiveItem=function(){var G;if(G=this.entity.previous("instance")){this.$itemRow(G).removeClass("active")}if(G=this.entity.get("instance")){this.$itemRow(G).addClass("active")}return this};E.prototype.setOrder=function(H){var I,G;I=$(H.target).data("id");G=this.model.get("order_dir");if(I===this.model.get("order_by")){G=G==="asc"?"desc":"asc"}else{G=this.entity.columns.get(I).get("order_dir")}this.model.set({order_by:I,order_dir:G});return this};E.prototype.render=function(){this.$el.html(this.template());this.$header=this.$component("header");this.$items=this.$component("items");this.renderHead();this.renderBody();return this};E.prototype.renderHead=function(){var I,H,K,G,J;H="";J=this.columns;for(K=0,G=J.length;K<G;K++){I=J[K];H+=this.renderHeadCell(I)}this.$header.html(H);return this.markOrderColumn()};E.prototype.renderHeadCell=function(G){return'<th class="'+(G.getClass())+'" id="'+(this.colCellId(G))+'" data-id="'+G.id+'">\n    '+(this.renderHeadCellValue(G))+"\n</th>"};E.prototype.renderHeadCellValue=function(H){var G,I;I=_.escape(H.getHeader());if(G=_.escape(H.getHelp())){I='<span class="glyphicon glyphicon-question-sign" title="'+G+'"></span> '+I}return I};E.prototype.renderBody=function(){var H,I,K,G,J;if(this.model.isEmpty()){this.$items.html(this.emptyTemplate());return this}H="";J=this.model.getData();for(K=0,G=J.length;K<G;K++){I=J[K];H+=this.renderRow(I)}this.$items.html(H);return this.markActiveItem()};E.prototype.renderRow=function(J){var I,H,L,G,K;H='<tr class="item '+(this.itemStates(J))+'" id="'+(this.itemRowId(J))+'" data-id="'+J.meta.id+'">';K=this.columns;for(L=0,G=K.length;L<G;L++){I=K[L];H+=this.renderCell(I,J)}return H+="</tr>"};E.prototype.itemStates=function(I){var G,H;H=I.attributes._states?I.attributes._states:"";if(((G=this.entity.get("instance"))!=null)&&I.meta.id===G.id){H+=" active"}return H};E.prototype.renderCell=function(G,H){return'<td class="'+(G.getClass())+'">\n    '+(G.render(H))+"\n</td>"};E.prototype.executeAction=function(I){var G,H;G=$(I.currentTarget);H=G.data("action");if(H&&(H=this[H])){I.preventDefault();H.call(this,G.closest(".item").data("id"),G)}};E.prototype.deleteItem=function(I,H){var G;if(!confirm(a.lang.confirm_delete)){return}G=H.closest(".item");H.attr("disabled",true);this.entity.destroy(I,{displayLoading:true,success:(function(J){return function(){G.fadeOut();return J.model.fetch()}})(this),fail:function(){return H.attr("disabled",false)}})};E.prototype.template=function(){return'<thead><tr id="'+(this.componentId("header"))+'"></tr></thead>\n<tbody class="items" id="'+(this.componentId("items"))+'"></tbody>'};E.prototype.emptyTemplate=function(){return'<tr class="empty">\n    <td colspan="'+this.columns.length+'">\n        '+a.lang.no_results+"\n    </td>\n</tr>"};E.prototype.colCellId=function(G){return this.componentId("col-"+G.id)};E.prototype.$colCell=function(G){return this.$component("col-"+G)};E.prototype.itemRowId=function(G){return this.componentId("item-"+G.meta.id)};E.prototype.$itemRow=function(G){return this.$component("item-"+G.meta.id)};return E})(a.View);g=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.className="filter-list";E.prototype.tagName="fieldset";E.prototype.events={"click .btn-apply":"apply","click .btn-reset":"reset"};E.prototype.initialize=function(G){this.entity=G.entity;this.availableFilters=G.filters;this.filterModel=new Backbone.Model;this.filterModel.entity=this.entity;this.listenTo(this.model,"request",(function(H){return function(){return H._toggleButtons(true)}})(this));this.listenTo(this.model,"data",(function(H){return function(){return H._toggleButtons(false)}})(this));this.listenTo(this.model,"change",(function(H){return function(){if(!H._applying){return H._setDataFromDataSource()}}})(this));this._setDataFromDataSource();return this};E.prototype._toggleButtons=function(G){this.$buttons.prop("disabled",G)};E.prototype.apply=function(){this._applying=true;this.model.set($.extend(this._prepareData(),{page:1}));this._applying=false;return this};E.prototype._prepareData=function(){var K,H,G,J,I;K={};I=this.filterModel.attributes;for(G in I){J=I[G];if(H=this.availableFilters.get(G)){K[H.getDataKey()]=H.prepareData(J)}}return K};E.prototype._setDataFromDataSource=function(){var K,H,J,G,I;K={};I=this.availableFilters.models;for(J=0,G=I.length;J<G;J++){H=I[J];K[H.id]=H.parseData(this.model.get(H.getDataKey()))}this.filterModel.set(K);return this};E.prototype.reset=function(){var H,J,G,I;I=this.filters;for(J=0,G=I.length;J<G;J++){H=I[J];H.empty()}return this.apply()};E.prototype.render=function(){var I,H,K,G,J;this.dispose();this.$el.html(this.template());this.items=this.$(".filter-list-container");J=this.availableFilters.models;for(K=0,G=J.length;K<G;K++){I=J[K];if(!(H=I.createFilterInput(this.filterModel))){continue}this.filters.push(H);this.items.append(H.render().el);H.$el.wrap('<div class="form-group '+(I.getClass())+'"></div>').parent().before("<label>"+(I.getLabel())+"</label>")}this.$buttons=this.$el.find(".fl-btn");return this};E.prototype.template=function(){return'<div class="filter-list-container"></div>\n<button type="button" class="btn fl-btn btn-primary btn-apply">'+a.lang.filter_apply+'</button>\n<button type="button" class="btn fl-btn btn-default btn-reset">'+a.lang.filter_reset+"</button>"};E.prototype.dispose=function(){var H,J,G,I;if(this.filters!=null){I=this.filters;for(J=0,G=I.length;J<G;J++){H=I[J];H.remove()}}this.filters=[];return this};E.prototype.remove=function(){this.dispose();return E.__super__.remove.apply(this,arguments)};return E})(Backbone.View);a.Inputs={};a.Inputs.Base=(function(F){A(E,F);function E(G){this.key=G.key;E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(){this.listenTo(this.model,"change:"+this.key,function(H,I,G){return this.applyChanges(I,!G.input||G.input!==this)});return this};E.prototype.applyChanges=function(G,H){return this};E.prototype.render=function(){return this.applyChanges(this.getValue(),true)};E.prototype.focus=function(){return this};E.prototype.getValue=function(){return this.model.get(this.key)};E.prototype.setValue=function(H,G){if(G==null){G={}}G.input=this;this.model.set(this.key,H,G);return this};E.prototype.emptyValue=function(){return null};E.prototype.empty=function(){return this.model.set(this.key,this.emptyValue())};return E})(a.View);a.Inputs.Static=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.tagName="p";E.prototype.className="form-control-static";E.prototype.initialize=function(G){if(G.formatter!=null){this.formatter=G.formatter}return E.__super__.initialize.apply(this,arguments)};E.prototype.applyChanges=function(G){return this.render()};E.prototype.render=function(){var G;G=this.getValue();if(this.formatter!=null){G=this.formatter.format(G)}this.$el.html(G);return this};return E})(a.Inputs.Base);a.Inputs.BaseText=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.className="form-control";E.prototype.events={change:"change",keydown:"keydown"};E.prototype.keydown=function(G){if(G.ctrlKey&&G.keyCode===13){return this.change()}return this};E.prototype.disable=function(){this.$el.prop("disabled",true);return this};E.prototype.enable=function(){this.$el.prop("disabled",false);return this};E.prototype.change=function(){return this.setValue(this.$el.val())};E.prototype.applyChanges=function(G,H){if(H){this.$el.val(G)}return this};E.prototype.focus=function(){this.el.focus();return this};return E})(a.Inputs.Base);a.Inputs.Text=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.tagName="input";E.prototype.initialize=function(G){G.mask&&this.$el.mask(G.mask);return E.__super__.initialize.apply(this,arguments)};return E})(a.Inputs.BaseText);a.Inputs.Textarea=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.tagName="textarea";return E})(a.Inputs.BaseText);a.Inputs.Checkbox=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.tagName="label";F.prototype.label="";F.prototype.events={change:"change"};F.prototype.initialize=function(G){if(G.label!=null){this.label=G.label}return F.__super__.initialize.apply(this,arguments)};F.prototype.change=function(){return this.setValue(this.input.prop("checked"))};F.prototype.applyChanges=function(G,H){if(H){this.input.prop("checked",G)}return this};F.prototype.render=function(){this.input=$("<input>",{type:"checkbox",checked:this.getValue()});this.$el.append(this.input);if(this.label!=null){this.$el.append(this.label)}return this};return F})(a.Inputs.Base);a.Inputs.Boolean=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.events={"click .btn":"check"};F.prototype.initialize=function(G){var H;this.tripleState=(H=G.tripleState)!=null?H:false;return F.__super__.initialize.apply(this,arguments)};F.prototype.check=function(I){var G,H;H=!!$(I.target).data("value");G=this.model.get(this.key);if(H===G&&this.tripleState){H=null}return this.setValue(H)};F.prototype.applyChanges=function(G){G=(function(){switch(G){case true:return 0;case false:return 1;default:return null}})();this.values.removeClass("active");if(G!=null){this.values.eq(G).addClass("active")}return this};F.prototype.render=function(){this.$el.html(this.template());this.values=this.$(".btn");return F.__super__.render.apply(this,arguments)};F.prototype.template=function(){return'<div class="btn-group">\n    <button type="button" class="btn btn-default" data-value="1">'+a.lang.yes+'</button>\n    <button type="button" class="btn btn-default" data-value="0">'+a.lang.no+"</button>\n</div>"};F.prototype.focus=function(){var G;if((G=this.values)!=null){G[0].focus()}return this};return F})(a.Inputs.Base);a.Inputs.EntityDropdown=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.className="entity-dropdown";F.prototype.events={"click .ed-item>.input-group-btn>.btn-remove":"removeItem","click .ed-item>.input-group-btn>.btn-edit":"editItem","click .ed-item>.form-control":"executeFirstAction","keydown .ed-item>.form-control":"itemKeydown","keydown [type=search]":"searchKeydown","show.bs.dropdown":"renderDropdown","shown.bs.dropdown":function(){j((function(G){return function(){return G.selector.focus()}})(this));return this},"hide.bs.dropdown":function(G){this.opened=false}};F.prototype.initialize=function(H){var I,G,J;if(H.multiple!=null){this.multiple=H.multiple}if(H.reference!=null){this.reference=H.reference}if(H.owner!=null){this.owner=H.owner}this.allowEdit=((I=H.allowEdit)!=null?I:true)&&this.reference.updatePermitted();this.placeholder=(G=H.placeholder)!=null?G:a.lang.not_selected;this.enabled=(J=H.enabled)!=null?J:true;this.editing=false;this.disableDropdown=false;this.opened=false;if(H.constraint){this.constraint=H.constraint;this.listenTo(this.model,"change:"+this.constraint.field,function(){return this.checkToDisable().applyConstraint(true)})}return F.__super__.initialize.apply(this,arguments)};F.prototype.getKey=function(G){return $(G.currentTarget).closest(".ed-item").data("key")};F.prototype.getValue=function(){return F.__super__.getValue.apply(this,arguments)||(this.multiple?[]:null)};F.prototype.removeItem=function(I){var G,H;if(this.multiple){G=this.getKey(I);H=_.clone(this.getValue());H.splice(G,1)}else{H=null}return this.setValue(H)};F.prototype.executeFirstAction=function(G){$(".btn:not(:disabled):last",$(G.currentTarget).next()).trigger("click");return false};F.prototype.editItem=function(I){var G,H;if(this.editing||!this.allowEdit){return}H=this.model.get(this.key);if(this.multiple){H=H[this.getKey(I)]}if(!H){return}G=$(I.currentTarget);if(G.is(".form-control")){G=G.next().children(".btn-edit")}G.prop("disabled",true);this.editing=this.reference.load(H.id).done((function(J){return function(K){var L;J.editingForm=L=a.Entity.Form.display(K);L.once("saved",function(M){G.parent().siblings(".form-control").text(M.getTitle());return L.remove()});L.once("destroyed",function(M){return J.removeItem(I)});return L.once("remove",function(){return J.editingForm=null})}})(this));this.editing.always((function(J){return function(){J.editing=null;return G.prop("disabled",false)}})(this));return this};F.prototype.searchKeydown=function(G){if(G.keyCode===27){if(this.selector){this.selector.$el.dropdown("toggle")}return false}};F.prototype.itemKeydown=function(G){if(G.keyCode===13){this.executeFirstAction(G);return false}};F.prototype.applyConstraint=function(G){var J,I,H;if(G==null){G=false}if(this.selector){J=this.model.entity.getField(this.constraint.field);I=this.model.get(this.constraint.field);if((H=this.selector.dataSource)!=null){H.set("constraint",J.prepareAttribute(I))}this.selector.attributesForNewModel[this.constraint.otherField]=I}if(G){this.model.set(this.key,this.multiple?[]:null)}return this};F.prototype.checkToDisable=function(){if(!this.enabled||this.constraint&&_.isEmpty(this.model.get(this.constraint.field))){this.disable()}else{this.enable()}return this};F.prototype.disable=function(){if(this.disableDropdown){return this}this.disableDropdown=true;return this.toggleDisableControls()};F.prototype.enable=function(){if(!this.disableDropdown){return this}this.disableDropdown=false;return this.toggleDisableControls()};F.prototype.toggleDisableControls=function(){this.dropdownBtn.prop("disabled",this.disableDropdown);this.$el.toggleClass("disabled",this.disableDropdown);return this};F.prototype.renderDropdown=function(G){if(this.disableDropdown){G.preventDefault();return}this.opened=true;if(!this.selector){this.selector=new a.Inputs.EntitySelector({model:this.model,key:this.key,multiple:this.multiple,reference:this.reference,allowCreate:this.allowEdit,owner:this.owner});if(this.constraint){this.applyConstraint()}this.$el.append(this.selector.render().el)}this.toggleOpenDirection()};F.prototype.toggleOpenDirection=function(){var I,H,G;if(!this.opened){return}G=$(window);I=G.height()-this.$el.offset().top-G.scrollTop()-this.$el.parent(".field-list").scrollTop();H=I>292?"open-down":"open-up";if(!this.$el.hasClass(H)){this.$el.removeClass("open-up open-down").addClass(H)}return this};F.prototype.applyChanges=function(G){if(this.multiple){this.renderItems()}else{this.updateItem();this.$el.removeClass("open")}this.toggleOpenDirection();return this};F.prototype.render=function(){this.dispose();if(this.multiple){this.renderMultiple()}else{this.renderSingle()}this.dropdownBtn=this.$("#"+this.cid+"-dropdown");this.$el.attr("id",this.cid);this.checkToDisable();return this};F.prototype.renderMultiple=function(){this.$el.append(this.items=$("<div>",{"class":"items"}));if(this.enabled){this.$el.append('<button type="button" class="btn btn-default btn-block dropdown-toggle ed-dropdown-toggle" data-toggle="dropdown" id="'+this.cid+'-dropdown" data-target="#'+this.cid+'">\n    '+a.lang.choose+'\n    <span class="caret"></span>\n</button>')}return this.renderItems()};F.prototype.renderItems=function(){var I,H,L,K,G,J;I="";J=this.getValue();for(H=K=0,G=J.length;K<G;H=++K){L=J[H];I+=this.itemTemplate(this.itemToString(L),H)}this.items.html(I);this.items.toggleClass("has-items",I!=="");return this};F.prototype.renderSingle=function(){this.$el.html(this.itemTemplate(this.placeholder,"0"));this.itemTitle=this.$(".form-control");this.itemDelete=this.$(".btn-remove");this.itemEdit=this.$(".btn-edit");return this.updateItem()};F.prototype.updateItem=function(){var G;G=this.getValue();this.itemTitle.text(G?this.itemToString(G):this.placeholder);this.itemDelete.toggle(!!G);this.itemEdit.toggle(!!G);return this};F.prototype.itemToString=function(G){var H;if(G.title!=null){return G.title}if(this.selector==null){return G.id}H=this.selector.dataSource.getById(G.id);if(H!=null){return H.title}else{return G.id}};F.prototype.itemTemplate=function(J,H){var I,G;if(H==null){H=null}G='<div class="input-group ed-item '+(!this.multiple?"ed-dropdown-toggle":"")+'" data-key="'+H+'">\n    <div class="form-control">'+(_.escape(J))+"</div>";if(!_.isEmpty(I=this.buttonsTemplate())){G+='<div class="input-group-btn">\n    '+I+"\n</div>"}return G+="</div>"};F.prototype.buttonsTemplate=function(){var G;G="";if(this.enabled){G+='<button type="button" class="btn btn-default btn-remove" tabindex="-1" title="'+a.lang.reset+'">\n    <span class="glyphicon glyphicon-remove"></span>\n</button>'}if(this.allowEdit){G+='<button type="button" class="btn btn-default btn-edit" tabindex="-1" title="'+a.lang.edit+'">\n    <span class="glyphicon glyphicon-pencil"></span>\n</button>'}if(!this.multiple){G+='<button type="button" class="btn btn-default btn-dropdown dropdown-toggle" data-toggle="dropdown" id="'+this.cid+'-dropdown" data-target="#'+this.cid+'" tab-index="1" title="'+a.lang.list_show+'">\n    <span class="glyphicon glyphicon-search"></span>\n</button>'}return G};F.prototype.focus=function(){var G;G=this.$component("dropdown");if(!this.multiple){G=G.parent().prev()}G[0].focus();if(_.isEmpty(this.getValue())){G.trigger("click")}return this};F.prototype.emptyValue=function(){if(this.multiple){return[]}else{return null}};F.prototype.dispose=function(){var H,G;if((H=this.selector)!=null){H.remove()}if((G=this.editingForm)!=null){G.remove()}return this};F.prototype.remove=function(){this.dispose();return F.__super__.remove.apply(this,arguments)};return F})(a.Inputs.Base);a.Inputs.EntitySelector=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.className="entity-selector";F.prototype.events={"click .items>.item":"checkItem","click .more":"loadMore","click .btn-add":"showNewForm","click .btn-refresh":"refresh","click [type=search]":function(){return false}};F.prototype.initialize=function(H){var I,G,K,J;F.__super__.initialize.apply(this,arguments);this.filter=(I=H.filter)!=null?I:false;this.multiple=(G=H.multiple)!=null?G:false;this.reference=H.reference;this.allowSearch=(K=H.allowSearch)!=null?K:true;this.allowCreate=((J=H.allowCreate)!=null?J:true)&&this.reference.createPermitted();this.attributesForNewModel={};this.makeSelectedMap(this.getValue());if(this.reference.readPermitted()){this.primaryKey="id";this.dataSource=this.reference.search({ajaxOptions:{data:{owner:H.owner}}});this.listenTo(this.dataSource,"request",this.displayLoading);this.listenTo(this.dataSource,"data",this.renderItems)}return this};F.prototype.getValue=function(){return F.__super__.getValue.apply(this,arguments)||(this.multiple?[]:null)};F.prototype.displayLoading=function(H,G){this.$el.addClass("loading");G.always((function(I){return function(){return I.$el.removeClass("loading")}})(this));return this};F.prototype.maybeLoadMore=function(){var G;G=this.items.parent().height();if((this.$more!=null)&&G>0&&G+50>this.$more.position().top){this.loadMore()}return this};F.prototype.refresh=function(G){if(G){G.preventDefault();G.stopPropagation()}this.dataSource.refresh()};F.prototype.checkItem=function(G){G.preventDefault();G.stopPropagation();this.selectItem(this.dataSource.getById($(G.target).data("id")))};F.prototype.selectItem=function(G){var H;if(!G){return}if(this.multiple){if(G.id in this.selected){H=_.filter(this.getValue(),function(I){return I.id.toString()!==G.id.toString()})}else{H=_.clone(this.getValue());H.push(G)}}else{H=G}return this.setValue(H)};F.prototype.loadMore=function(){if(!this.dataSource||this.dataSource.inProgress()){return}this.dataSource.next();return false};F.prototype.showNewForm=function(I){var H,G;if(I){I.preventDefault();I.stopPropagation()}if(this.newModelForm){return}G=this.reference.createInstance({attributes:this.attributesForNewModel});this.newModelForm=H=a.Entity.Form.display(G);H.once("remove",(function(J){return function(){return J.newModelForm=null}})(this));H.once("created",(function(J){return function(K,L){J.selectItem(K.meta);H.remove()}})(this));return this};F.prototype.applyChanges=function(G){this.makeSelectedMap(G);return this.renderItems()};F.prototype.makeSelectedMap=function(J){var H,I,G;this.selected={};if(!J){return this}if(this.multiple){for(I=0,G=J.length;I<G;I++){H=J[I];this.selected[H.id]=true}}else{if(J!=null){this.selected[J.id]=true}}return this};F.prototype.renderItems=function(){var H,I,K,G,J;this.$more=null;H="";if(this.dataSource.data.length||this.dataSource.more){J=this.dataSource.data;for(K=0,G=J.length;K<G;K++){I=J[K];H+=this.renderItem(I)}if(this.dataSource.more){H+='<li class="more">'+a.lang.more+"</li>"}}else{H+='<li class="empty">'+a.lang.no_results+"</li>"}this.items.html(H);if(this.dataSource.more){this.$more=this.items.children(".more");this.maybeLoadMore()}return this};F.prototype.renderItem=function(H){var G;G=H.id in this.selected?"selected":"";return'<li class="item '+G+'" data-id="'+H.id+'">'+H.title+"</li>"};F.prototype.render=function(){if(this.reference.readPermitted()){this.dispose();this.$el.html(this.template());this.items=this.$(".items");this.renderItems();this.items.parent().on("scroll",$.proxy(this,"maybeLoadMore"));if(this.allowSearch){this.renderSearch()}if(this.dataSource.isEmpty()){this.dataSource.refresh()}}else{this.$el.html("<span class=error>"+a.lang.forbidden+"</span>")}return this};F.prototype.renderSearch=function(){this.searchInput=new a.Inputs.Search({model:this.dataSource,key:"keywords"});this.$el.prepend(this.searchInput.render().$el);this.searchInput.$el.wrap("<div class=search-input-container></div>");this.searchInput.appendButton('<button type="button" class="btn btn-default btn-refresh" tabindex="-1" title="'+a.lang.refresh+'">\n    <span class="glyphicon glyphicon-refresh"></span>\n</button>');if(this.allowCreate){this.searchInput.appendButton("<button type=\"button\" class='btn btn-default btn-add' tabindex='-1' title=\""+a.lang.model_new_record+"\">\n    <span class='glyphicon glyphicon-plus'></span>\n</button>")}return this};F.prototype.template=function(){return'<div class="items-container"><ul class="items"></ul></div>'};F.prototype.focus=function(){var G;((G=this.searchInput)!=null?G.focus():void 0)||this.entity.done((function(H){return function(){return H.searchInput.focus()}})(this));return this};F.prototype.dispose=function(){var H,G;if((H=this.searchInput)!=null){H.remove()}if((G=this.newModelForm)!=null){G.remove()}return this};F.prototype.remove=function(){this.dispose();return F.__super__.remove.apply(this,arguments)};return F})(a.Inputs.Base);a.Inputs.FileList=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.className="file-list";E.prototype.events={"change [type=file]":"appendFiles","click .action-delete":"deleteFile"};E.prototype.initialize=function(H){var I,G,J;this.multiple=(I=H.multiple)!=null?I:false;this.formatter=(G=H.formatter)!=null?G:{format:function(K){if(K instanceof File){return K.name}else{return K}}};this.accepts=(J=H.accepts)!=null?J:"";this.counter=1;return E.__super__.initialize.apply(this,arguments)};E.prototype.deleteFile=function(G){var H;if(this.multiple){H=$(G.currentTarget).data("cid");this.setValue(_.reject(this.getValue(),(function(I){return function(J){return I.itemId(J)===H}})(this)))}else{this.setValue(null)}return false};E.prototype.appendFiles=function(M){var H,O,K,J,N,G,L,I;if(M.target.files.length===0){return}L=M.target.files;for(K=0,N=L.length;K<N;K++){H=L[K];H.cid=this.cid+"_"+this.counter++}if(this.multiple){O=_.clone(this.model.get(this.key));I=M.target.files;for(J=0,G=I.length;J<G;J++){H=I[J];O.push(H)}}else{O=M.target.files[0]}return this.setValue(O)};E.prototype.applyChanges=function(){return this.render()};E.prototype.render=function(){var H,I,L,K,G,J;L=this.model.get(this.key);H="";if(L){J=this.multiple?L:[L];for(K=0,G=J.length;K<G;K++){I=J[K];H+=this.renderItem(I)}}if(H.length){H=this.wrapItems(H)}H+=this.renderInput(this.multiple?"<span class='glyphicon glyphicon-plus'></span> "+a.lang.add:a.lang.choose);this.$el.html(H);return this};E.prototype.wrapItems=function(G){return'<ul class="list-group">'+G+"</ul>"};E.prototype.renderInput=function(G){return'<div class="btn btn-sm btn-default file-list-input-wrap">\n    <input type="file" id="'+(this.componentId("input"))+'" accept="'+this.accepts+'"'+(this.multiple?" multiple":"")+">\n    "+G+"\n</div>"};E.prototype.renderItem=function(H){var G;G=this.formatter.format(H);return'<li class="list-group-item">\n    <a href="#" class="action-delete pull-right" data-cid="'+(this.itemId(H))+'"><span class="glyphicon glyphicon-remove"></span></a>\n\n    '+G+"\n</li>"};E.prototype.itemId=function(G){if(G instanceof File){return G.cid}else{return G}};E.prototype.focus=function(){this.$component("input")[0].focus();return this};return E})(a.Inputs.Base);a.Inputs.ImageList=(function(E){A(F,E);F.prototype.className="image-list";function F(){this.readers=[];F.__super__.constructor.apply(this,arguments)}F.prototype.initialize=function(H){var I,G;this.width=(I=H.width)!=null?I:0;this.height=(G=H.height)!=null?G:80;return F.__super__.initialize.apply(this,arguments)};F.prototype.render=function(){var G,J,H,I;F.__super__.render.apply(this,arguments);I=this.readers;for(J=0,H=I.length;J<H;J++){G=I[J];G.readAsDataURL(G.item)}this.readers=[];return this};F.prototype.wrapItems=function(G){return'<ul class="image-group">'+G+"</ul>"};F.prototype.renderItem=function(G){return'<li class="image-group-item">\n    '+(this.renderImage(G))+'\n    <a href="#" class="action-delete" data-cid="'+(this.itemId(G))+'"><span class="glyphicon glyphicon-remove"></span></a>\n</li>'};F.prototype.renderImage=function(H){var I,G;if(G=H instanceof File){I=H.data||"";if(H.data==null){this.readers.push(this.createPreviewLoader(H))}}else{I=u(H,this.width,this.height)}return'<a href="'+(G?H.data||"#":a.root+"/"+H)+'" class="img-wrap" data-trigger="fancybox">\n    <img src="'+I+'" '+(G?"id='"+H.cid+"'":"")+">\n</a>"};F.prototype.createPreviewLoader=function(H){var G;G=new FileReader;G.item=H;G.onload=function(I){I.target.item.data=I.target.result;return $("#"+H.cid).attr("src",I.target.result).parent().attr("href",I.target.result)};return G};return F})(a.Inputs.FileList);a.Inputs.Search=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.className="input-group";E.prototype.events={"click .btn-search":"search"};E.prototype.initialize=function(G){this.input=new a.Inputs.Text({model:this.model,key:G.key,attributes:{type:"search",placeholder:a.lang.search}});return E.__super__.initialize.apply(this,arguments)};E.prototype.search=function(G){if(G){G.preventDefault();G.stopPropagation()}this.input.change()};E.prototype.appendButton=function(G){return this.$btns.append(G)};E.prototype.render=function(){this.$el.append(this.input.render().$el);this.$el.append(this.$btns=$('<div class="input-group-btn"></div>'));this.appendButton('<button type="button" class="btn btn-default btn-search" title="'+a.lang.find+'">\n    <span class="glyphicon glyphicon-search"></span>\n</button>');return this};E.prototype.focus=function(){this.input.focus();return this};return E})(a.View);a.Inputs.Slug=(function(E){A(F,E);F.prototype.events={"click .btn":"toggleSyncing"};function F(G){this.input=new a.Inputs.Text(_.clone(G));if(G.className==null){G.className="input-group"}if(G.attributes!=null){delete G.attributes}F.__super__.constructor.apply(this,arguments)}F.prototype.initialize=function(G){this.key=G.key;this.ref=_.isArray(G.field)?G.field:G.field?[G.field]:void 0;if(!this.ref){this.$el.removeClass("input-group")}this.listenTo(this.model,"change:"+this.key,(function(H){return function(){if(!H.linkable()){return H.unlink()}}})(this));return F.__super__.initialize.apply(this,arguments)};F.prototype.toggleSyncing=function(){if(this.syncButton.hasClass("active")){this.unlink()}else{this.link()}return this};F.prototype.link=function(){if(!this.ref){return}this.listenTo(this.model,"change:"+this.ref.join(" change:"),this.sync);this.syncButton.addClass("active");this.input.disable();return this.sync()};F.prototype.unlink=function(){if(this.ref!=null){this.stopListening(this.model,null,this.sync)}this.syncButton.removeClass("active");this.input.enable();return this};F.prototype.linkable=function(){var G,H;G=this.model.get(this.key);H=this.getSlug();return H===G||G===null&&H===""};F.prototype.sync=function(){this.model.set(this.key,this.getSlug());return this};F.prototype.getSlug=function(){var J,I,H,L,G,K;J=[];K=this.ref;for(L=0,G=K.length;L<G;L++){I=K[L];H=this.model.get(I);if(H){J.push(H)}}if(J.length){return J.join(" ")}else{return""}};F.prototype.render=function(){this.$el.html(this.template());this.$el.prepend(this.input.render().el);if(this.ref!=null){this.syncButton=this.$(".btn");if(this.linkable()){this.link()}}return this};F.prototype.template=function(){if(this.ref==null){return""}return'<div class="input-group-btn">\n    <button type="button" tabindex="-1" class="btn btn-default" title="'+a.lang.slug_sync+'"><span class="glyphicon glyphicon-link"></span></button>\n</div>'};return F})(Backbone.View);a.Inputs.Select=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.tagName="select";F.prototype.initialize=function(H){var I,G,K,J;this.items=(I=H.items)!=null?I:{};this.prompt=(G=H.prompt)!=null?G:null;this.required=(K=H.required)!=null?K:false;this.multiple=(J=H.multiple)!=null?J:false;if(this.multiple){this.$el.attr("multiple","multiple")}return F.__super__.initialize.apply(this,arguments)};F.prototype.render=function(){this.$el.html(this.template());if(this.required&&!this.getValue()){this.setValue(this.$el.val())}return F.__super__.render.apply(this,arguments)};F.prototype.applyChanges=function(G,H){if(H){this.$el.val(this._transformValue(G))}return this};F.prototype._transformValue=function(G){if((_.isString(G)||_.isArray(G))&&!G.length){return this.emptyValue()}if(_.isArray(G)){if(this.multiple){return G}else{return G[0]}}else{if(this.multiple){return[G]}else{return G}}};F.prototype.emptyValue=function(){if(this.multiple){return[]}else{return null}};F.prototype.template=function(){var I,H,K,J,G;I="";if(this.hasPrompt()){I+=this.optionTemplate("",(J=this.prompt)!=null?J:a.lang.not_selected,this.required)}G=this.items;for(H in G){K=G[H];I+=this.optionTemplate(H,K)}return I};F.prototype.optionTemplate=function(H,I,G){if(G==null){G=false}return'<option value="'+(_.escape(H))+'"'+(G?" disabled":"")+">"+(_.escape(I))+"</option>"};F.prototype.hasPrompt=function(){return !this.multiple&&(!this.required||this.prompt)};return F})(a.Inputs.BaseText);a.Inputs.NumberFilter=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.className="input-group number-filter";F.prototype.events={"click .dropdown-menu a":"changeOperator",change:"changeValue"};F.prototype.initialize=function(){this.defaultOp=">";if(!this.getValue()){this.setValue(this.emptyValue(),{silent:true})}return F.__super__.initialize.apply(this,arguments)};F.prototype.changeOperator=function(H){var I,G;H.preventDefault();I=$(H.currentTarget).data("op");G=this.getValue();if(G.op!==I){this.setValue(this.makeValue(I,G.val))}return this};F.prototype.changeValue=function(H){var G;G=this.getValue();this.setValue(this.makeValue(G.op,H.target.value));return this};F.prototype.applyChanges=function(G,H){this.$(".dropdown-menu li").removeClass("active");this.$(".dropdown-menu a[data-op='"+G.op+"']").parent().addClass("active");this.op.text(G.op);if(H){this.input.val(G.val)}return this};F.prototype.render=function(){this.$el.html(this.template());this.op=this.$component("op");this.input=this.$component("input");this.reset=this.$component("reset");return F.__super__.render.apply(this,arguments)};F.prototype.template=function(){return'<div class="input-group-btn">\n    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">\n        <span id="'+(this.componentId("op"))+'" class="value">=</span>\n        <span class="caret"></span>\n    </button>\n\n    <ul class="dropdown-menu">\n        <li><a href="#" data-op="=">=</a></li>\n        <li><a href="#" data-op="&gt;">&gt;</a></li>\n        <li><a href="#" data-op="&lt;">&lt;</a></li>\n    </ul>\n</div>\n\n<input type="text" class="form-control" id="'+(this.componentId("input"))+'">'};F.prototype.makeValue=function(H,G){return{op:H,val:G}};F.prototype.emptyValue=function(){return this.makeValue(this.defaultOp,"")};return F})(a.Inputs.Base);a.Inputs.DateTime=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.tagName="input";F.prototype.initialize=function(G){this.format=G.format;if(G.mask!=null){this.$el.mask(G.mask)}return F.__super__.initialize.apply(this,arguments)};F.prototype.applyChanges=function(G,H){this.$el.val(G===null?"":H?moment.unix(G).format(this.format):void 0);return this};F.prototype.change=function(){var G;G=this.$el.val();G=_.isEmpty(G)?null:moment(G,this.format).unix();this.setValue(G);return this.applyChanges(G,true)};return F})(a.Inputs.BaseText);a.Layout={};a.Layout.Element=(function(F){A(E,F);function E(G,H){var I;this.parent=H;this.disable=(I=G.disable)!=null?I:false;E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(){if(!this.model&&this.parent){this.model=this.parent.model}if(this.model){this.entity=this.model.entity}return E.__super__.initialize.apply(this,arguments)};E.prototype.handleValidationError=function(G){if(this.parent){this.parent.handleValidationError(G)}return this};E.prototype.isDisabled=function(){if(this.disable){return true}if(this.parent){return this.parent.isDisabled()}return false};E.prototype.isFocusable=function(){return false};E.prototype.focus=function(){return this};return E})(a.View);a.Layout.Container=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G){E.__super__.initialize.apply(this,arguments);this.$container=this.$el;this.items=[];if(G.items){this.createItems(G.items)}return this};E.prototype.create=function(G){var H;H=y(G["class"]);if(!H||!_.isFunction(H)){console.error("Couldn't resolve element of type ",G["class"]);return}return this.append(new H(G,this))};E.prototype.createItems=function(H){var I,J,G;for(J=0,G=H.length;J<G;J++){I=H[J];this.create(I)}return this};E.prototype.append=function(G){if(G){this.items.push(G)}return G};E.prototype.renderElement=function(G){this.$container.append(G.render().$el);return this};E.prototype.render=function(){var H,J,G,I;if(this.items){I=this.items;for(J=0,G=I.length;J<G;J++){H=I[J];this.renderElement(H)}}return E.__super__.render.apply(this,arguments)};E.prototype.remove=function(){var H,J,G,I;I=this.items;for(J=0,G=I.length;J<G;J++){H=I[J];H.remove()}return E.__super__.remove.apply(this,arguments)};E.prototype.getFocusable=function(){return _.find(this.items,function(G){return G.isFocusable()})};E.prototype.isFocusable=function(){return this.getFocusable()!=null};E.prototype.focus=function(){var G;if(G=this.getFocusable()){G.focus()}return this};return E})(a.Layout.Element);a.Layout.BaseFieldContainer=(function(E){A(F,E);function F(G){var H;this.title=(H=G.title)!=null?H:null;F.__super__.constructor.apply(this,arguments)}return F})(a.Layout.Container);a.Layout.FieldSet=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.tagName="fieldset";F.prototype.render=function(){this.$el.html(this.template());this.$container=this.$component("body");return F.__super__.render.apply(this,arguments)};F.prototype.template=function(){var G;G=this.title?"<legend>"+_.escape(this.title)+"</legend>":"";return G+"<div id='"+this.componentId("body")+"'></div>"};return F})(a.Layout.BaseFieldContainer);a.Layout.TabPane=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.className="tab-pane";E.prototype.initialize=function(G){E.__super__.initialize.apply(this,arguments);if(!G.title){this.title=this.entity.get("title").singular}this.$el.attr("id",this.cid);this.listenTo(this.model,"request",function(){if(this.header){return this.header.resetErrors()}});return this};E.prototype.activate=function(){var G;if((G=this.header)!=null){G.activate()}j((function(H){return function(){return H.focus()}})(this));return this};E.prototype.getHeader=function(){if(!this.header){this.header=new a.Layout.TabPane.Header({model:this})}return this.header};E.prototype.handleValidationError=function(){var G;if((G=this.header)!=null){G.incrementErrors()}return E.__super__.handleValidationError.apply(this,arguments)};return E})(a.Layout.BaseFieldContainer);a.Layout.TabPane.Header=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.tagName="li";F.prototype.events={"shown.bs.tab":function(){j((function(G){return function(){return G.model.focus()}})(this))}};F.prototype.initialize=function(){this.errors=0;return F.__super__.initialize.apply(this,arguments)};F.prototype.incrementErrors=function(){this.$badge.text(++this.errors);return this};F.prototype.resetErrors=function(){this.errors=0;this.$badge.text("");return this};F.prototype.render=function(){this.$el.html(this.template());this.$badge=this.$component("badge");return F.__super__.render.apply(this,arguments)};F.prototype.template=function(){return'<a href="#'+this.model.cid+'" role="tab" data-toggle="tab">\n    '+this.model.title+'\n    <span class="badge" id="'+(this.componentId("badge"))+'"></span>\n</a>'};F.prototype.activate=function(){this.$("a").tab("show");return this};return F})(a.View);a.Layout.Row=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.className="row";return E})(a.Layout.Container);a.Layout.Col=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.initialize=function(G){this.$el.addClass("col-xs-"+G.span);return F.__super__.initialize.apply(this,arguments)};return F})(a.Layout.BaseFieldContainer);a.Layout.Field=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G){E.__super__.initialize.apply(this,arguments);this.fieldView=null;if(!(this.field=this.entity.field(G.field))){console.error("The field "+G.field+" is not found in "+this.entity.id+".")}return this};E.prototype.render=function(){if(this.field&&this.field.isVisible()){this.fieldView=this.field.createView(this.model,this.isDisabled(),this)}if(this.fieldView){this.$el.html(this.fieldView.render().$el)}return this};E.prototype.remove=function(){if(this.fieldView){this.fieldView.remove()}return E.__super__.remove.apply(this,arguments)};E.prototype.isFocusable=function(){return this.fieldView&&this.fieldView.isFocusable()};E.prototype.focus=function(){if(this.fieldView){this.fieldView.focus()}return this};return E})(a.Layout.Element);a.Layout.Text=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.tagName="p";E.prototype.className="text-node";E.prototype.initialize=function(G){if(G.contents){this.$el.html(G.contents)}return E.__super__.initialize.apply(this,arguments)};return E})(a.Layout.Element);b=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.className="field-list";E.prototype.initialize=function(){var J,I,G,H;E.__super__.initialize.apply(this,arguments);H=this.entity.fields.models;for(I=0,G=H.length;I<G;I++){J=H[I];this.append(new a.Layout.Field({field:J.id},this))}return this};return E})(a.Layout.BaseFieldContainer);a.Layout.Layout=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(){E.__super__.initialize.apply(this,arguments);return this.setupLayout()};E.prototype.setupLayout=function(){if(this.entity.attributes.layout){this.createItems(this.entity.attributes.layout)}else{this.setupDefaultLayout()}return this};E.prototype.setupDefaultLayout=function(){return this};return E})(a.Layout.Container);a.Fields.BaseView=(function(F){A(E,F);function E(H){var I,K,G,J;this.field=K=H.field;G=H.model;this.inputId=[G.entity.id,K.id,G.cid].join("__");I="form-group field field__"+(K.getType())+" field--"+K.id+" field--"+G.entity.id+"--"+K.id;this.className=this.className?I+" "+this.className:I;this.forceDisable=(J=H.forceDisable)!=null?J:false;E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G){this.listenTo(this.model,"sync",this.handleSync);this.listenTo(this.model,"request",this.handleRequest);this.listenTo(this.model,"invalid",this.handleInvalid);return this.updateContainer()};E.prototype.handleSync=function(){return this.updateContainer()};E.prototype.handleRequest=function(){return this.hideError()};E.prototype.handleInvalid=function(H,I){var G;if(this.field.id in I){G=I[this.field.id];this.showError(_.isArray(G)?_.first(G):G)}return this};E.prototype.updateContainer=function(){this.isEditable=!this.forceDisable&&this.field.isEditable(this.model);this.$el.toggle(this.isVisible());this.$el.toggleClass("required",this.field.isRequired(this.model));return this};E.prototype.hideError=function(){this.error.hide();return this};E.prototype.showError=function(G){this.error.text(G).show();this.handleValidationError(G);return this};E.prototype.focus=function(){return this};E.prototype.render=function(){this.$(".field-help").tooltip({container:"body",placement:"left"});this.error=this.$component("error");return this};E.prototype.helpTemplate=function(){var G;G=this.field.getHelp();if(G){return'<span class="glyphicon glyphicon-question-sign field-help" title="'+(_.escape(G))+'"></span>'}else{return""}};E.prototype.errorTemplate=function(){return'<span class="help-block error" style="display:none;" id="'+(this.componentId("error"))+'"></span>'};E.prototype.isVisible=function(){return this.isEditable||!this.model.isNew()};E.prototype.isFocusable=function(){return this.field.isEditable(this.model)};E.prototype.dispose=function(){return this};E.prototype.remove=function(){this.dispose();return E.__super__.remove.apply(this,arguments)};return E})(a.Layout.Element);a.Fields.InputView=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.updateContainer=function(){var G;G=this.isEditable;E.__super__.updateContainer.apply(this,arguments);if((G!=null)&&G!==this.isEditable){return this.render()}};E.prototype.hideError=function(){this.$el.removeClass("has-error");return E.__super__.hideError.apply(this,arguments)};E.prototype.showError=function(){this.$el.addClass("has-error");return E.__super__.showError.apply(this,arguments)};E.prototype.render=function(){this.dispose();this.$el.html(this.template());this.input=this.field.createInput(this.model,this.inputId,this.forceDisable);this.$el.append(this.input.render().el);this.$el.append(this.errorTemplate());return E.__super__.render.apply(this,arguments)};E.prototype.label=function(G){if(G==null){G=this.field.getLabel()}return'<label for="'+this.inputId+'" class="field-label">\n    '+(this.helpTemplate())+(_.escape(G))+"\n</label>"};E.prototype.template=function(){return this.label()};E.prototype.focus=function(){var G;if((G=this.input)!=null){G.focus()}return this};E.prototype.dispose=function(){var G;if((G=this.input)!=null){G.remove()}return this};return E})(a.Fields.BaseView);a.Fields.Base=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.viewConstructor=a.Fields.InputView;E.prototype.createView=function(G,I,H){if(I==null){I=false}return new this.viewConstructor({model:G,field:this,forceDisable:I},H)};E.prototype.createInput=function(I,H,J){var G;if(J==null){J=false}if(!J&&this.isEditable(I)){G=this.createEditableInput(I,H)}return G||this.createStaticInput(I)};E.prototype.createStaticInput=function(G){return new a.Inputs.Static({model:G,key:this.id,formatter:this})};E.prototype.createEditableInput=function(H,G){return null};E.prototype.createFilterInput=function(G){return null};E.prototype.getFilterLabel=function(){return this.attributes.label};E.prototype.format=function(G){return G||o};E.prototype.getLabel=function(){return this.attributes.label};E.prototype.isEditable=function(G){return G.canBeSaved()&&this.attributes.disabled!==true&&this.attributes.disabled!==G.action()};E.prototype.isRequired=function(G){return this.attributes.required===true||this.attributes.required===G.action()};E.prototype.isUnique=function(){return this.attributes.unique};E.prototype.hasChangedSinceSync=function(G){return !this.valuesEqual(G.get(this.id),G.getOriginal(this.id))};E.prototype.valuesEqual=function(H,G){return H===G};E.prototype.isCopyable=function(){return !this.isUnique()};E.prototype.copyAttribute=function(G,H){return G.get(this.id)};E.prototype.parse=function(G,H){return H};E.prototype.prepareAttribute=function(G){return G};E.prototype.prepareFilterData=function(G){return this.prepareAttribute(G)};E.prototype.parseFilterData=function(G){return G};return E})(a.Attribute);a.Fields.Input=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.createEditableInput=function(I,H){var G;G=this.createBaseInput(I,H);if(this.attributes.prepend||this.attributes.append){return new a.Fields.Input.PrependAppendWrapper({prepend:this.attributes.prepend,append:this.attributes.append,input:G})}return G};F.prototype.createBaseInput=function(H,G){return new a.Inputs.Text({model:H,key:this.id,mask:this.attributes.mask,attributes:{placeholder:this.attributes.placeholder,id:G,type:this.attributes.input_type||"input"}})};F.prototype.format=function(G){if(G===null||G===""){return o}if(this.attributes.append){G+=" "+this.attributes.append}if(this.attributes.prepend){G=this.attributes.prepend+" "+G}return G};F.prototype.prepareAttribute=function(G){if(_.isArray(G)){return G.join(",")}else{return G}};F.prototype.getType=function(){return"string"};return F})(a.Fields.Base);a.Fields.Input.PrependAppendWrapper=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.className="input-group";E.prototype.initialize=function(G){if(G.prepend){this.$el.append(this.createAddon(G.prepend))}this.$el.append((this.input=G.input).$el);if(G.append){return this.$el.append(this.createAddon(G.append))}};E.prototype.render=function(){this.input.render();return this};E.prototype.createAddon=function(G){return"<span class=input-group-addon>"+_.escape(G)+"</span>"};return E})(a.View);a.Fields.Text=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.createEditableInput=function(H,G){return new a.Inputs.Textarea({model:H,key:this.id,attributes:{placeholder:this.attributes.placeholder,id:G,rows:this.attributes.rows}})};E.prototype.format=function(G){if(G){return'<pre class="limit-height">'+G+"</pre>"}else{return o}};E.prototype.getType=function(){return"text"};return E})(a.Fields.Base);a.Fields.BaseDateTime=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.inputFormat=null;E.prototype.mask=null;E.prototype.createEditableInput=function(H,G){return new a.Inputs.DateTime({model:H,key:this.id,format:this.inputFormat,mask:this.mask,attributes:{id:this.inputId}})};E.prototype.formatDate=function(G){return moment.unix(G).format(this.inputFormat)};E.prototype.format=function(G){if(G===null){return o}else{return this.formatDate(G)}};E.prototype.getType=function(){return"datetime"};return E})(a.Fields.Base);a.Fields.Date=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.inputFormat="YYYY-MM-DD";E.prototype.mask="9999-99-99";return E})(a.Fields.BaseDateTime);a.Fields.Time=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.inputFormat="HH:mm:ss";E.prototype.mask="99:99:99";return E})(a.Fields.BaseDateTime);a.Fields.DateTime=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.inputFormat="YYYY-MM-DD HH:mm:ss";F.prototype.mask="9999-99-99 99:99:99";F.prototype.formatDate=function(G){return moment.unix(G).fromNow()};return F})(a.Fields.BaseDateTime);a.Fields.Boolean=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.createEditableInput=function(G){return new a.Inputs.Boolean({model:G,key:this.id})};F.prototype.createFilterInput=function(G){return new a.Inputs.Boolean({model:G,key:this.id,tripleState:true})};F.prototype.format=function(G){if(G){return a.lang.yes}else{return a.lang.no}};F.prototype.prepareAttribute=function(G){if(G===false){return 0}if(G===true){return 1}return null};F.prototype.parseFilterData=function(G){G=parseInt(G);if(G===1){return true}if(G===0){return false}return null};F.prototype.getType=function(){return"bool"};return F})(a.Fields.Base);a.Fields.BaseRelation=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.isVisible=function(){return this.getReferencedEntity().readPermitted()&&E.__super__.isVisible.apply(this,arguments)};E.prototype.getReferencedEntity=function(){if(!this.reference){this.reference=a.app.entity(this.attributes.reference)}return this.reference};E.prototype.getFilterLabel=function(){return this.getReferencedEntity().getSingularTitle()};E.prototype.formatItem=function(G){return G.title};E.prototype.format=function(G){if(_.isEmpty(G)){return o}if(this.attributes.multiple){return _.map(G,(function(H){return function(I){return H.formatItem(I)}})(this)).join(", ")}else{return this.formatItem(G)}};E.prototype.getType=function(){return"relation"};return E})(a.Fields.Base);a.Fields.Relation=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.createInput=function(H,G,I){if(I==null){I=false}return new a.Inputs.EntityDropdown({model:H,key:this.id,multiple:this.attributes.multiple,reference:this.getReferencedEntity(),owner:this.entity.id+"."+this.id,constraint:this.attributes.constraint,enabled:!I&&this.isEditable(H)})};F.prototype.createFilterInput=function(G){return new a.Inputs.EntityDropdown({model:G,key:this.id,reference:this.getReferencedEntity(),allowEdit:false,placeholder:a.lang.any_value,owner:this.entity.id+"."+this.id,constraint:this.attributes.constraint,multiple:true})};F.prototype.isEditable=function(){return this.getReferencedEntity().readPermitted()&&F.__super__.isEditable.apply(this,arguments)};F.prototype.canFilter=function(){return this.getReferencedEntity().readPermitted()&&F.__super__.canFilter.apply(this,arguments)};F.prototype.formatItem=function(H){var G;G=this.getReferencedEntity();if(!G.readPermitted()){return H.title}return'<a href="'+(G.link(H.id))+'">'+(_.escape(H.title))+"</a>"};F.prototype.prepareAttribute=function(G){if(G==null){return null}if(_.isArray(G)){return _.pluck(G,"id").join(",")}return G.id};F.prototype.prepareFilterData=function(G){G=F.__super__.prepareFilterData.apply(this,arguments);if(_.isEmpty(G)){return null}else{return G}};F.prototype.parseFilterData=function(G){if(!(_.isString(G)||_.isNumber(G))){return null}G=G.toString();if(!G.length){return null}G=G.split(",");return _.map(G,function(H){return{id:H}})};return F})(a.Fields.BaseRelation);a.Fields.File=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.createEditableInput=function(G){return new a.Inputs.FileList({model:G,key:this.id,multiple:this.attributes.multiple,accepts:this.attributes.accepts})};E.prototype.format=function(G){if(G instanceof E){return G.name}else{return G}};E.prototype.getType=function(){return"file"};return E})(a.Fields.Base);a.Fields.Image=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.createEditableInput=function(G){return new a.Inputs.ImageList({model:G,key:this.id,width:this.attributes.width,height:this.attributes.height,multiple:this.attributes.multiple,accepts:this.attributes.accepts})};E.prototype.createStaticInput=function(G){return new a.Inputs.Static({model:G,key:this.id,formatter:new a.Fields.Image.Formatter({width:this.attributes.width,height:this.attributes.height})})};E.prototype.getType=function(){return"image"};return E})(a.Fields.File);a.Fields.Image.Formatter=(function(){function E(F){this.options=F;return}E.prototype.imageUrl=function(F){return a.root+"/"+F};E.prototype.imageThumb=function(F){return u(F,this.options.width,this.options.height)};E.prototype.format=function(I){var G,J,H,F;G='<ul class="image-group">';if(!_.isArray(I)){I=[I]}for(H=0,F=I.length;H<F;H++){J=I[H];G+='<li class="image-group-item">\n    <a href="'+(this.imageUrl(J))+'" class="img-wrap" data-trigger="fancybox">\n        <img src="'+(this.imageThumb(J))+'">\n    </a>\n</li>'}return G+"</ul>"};return E})();a.Fields.Slug=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.createEditableInput=function(G){return new a.Inputs.Slug({model:G,key:this.id,field:this.attributes.field,attributes:{placeholder:this.attributes.placeholder}})};F.prototype.getType=function(){return"slug"};return F})(a.Fields.Base);a.Fields.Enum=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.createBaseInput=function(H,G){return new a.Inputs.Select({model:H,key:this.id,prompt:this.attributes.prompt,items:this.attributes.items,required:this.attributes.required,multiple:this.attributes.multiple,attributes:{id:G}})};E.prototype.createFilterInput=function(G){return new a.Inputs.Select({model:G,key:this.id,prompt:a.lang.any_value,items:this.attributes.items,multiple:true})};E.prototype.format=function(I){var G,H,J;G=this.attributes.items;if(!_.isArray(I)){I=[I]}J=(function(){var M,L,K;K=[];for(M=0,L=I.length;M<L;M++){H=I[M];K.push(H in G?G[H]:H)}return K})();return J.join(", ")};E.prototype.parseFilterData=function(G){if(_.isString(G)){return G.split(",")}else{return null}};E.prototype.getType=function(){return"enum"};return E})(a.Fields.Input);a.Fields.EmbeddedView=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.className="has-many-view";E.prototype.events={"click .btn-create":"create"};E.prototype.initialize=function(G){var H;this.views={};this.collection=H=this.model.get(this.field.id);this.listenTo(H,"add",this.add);this.listenTo(H,"remove",this.removeItem);this.listenTo(H,"removeSoftly restore",this.update);this.listenTo(H,"reset",this.render);return E.__super__.initialize.apply(this,arguments)};E.prototype.handleInvalid=function(G,H){if(this.field.id in H&&H[this.field.id].length){E.__super__.handleInvalid.apply(this,arguments)}return this};E.prototype.create=function(G){G.preventDefault();G.stopPropagation();this.collection.add(this.field.getReferencedEntity().createInstance(),{focus:true});return this};E.prototype.add=function(I,K,H){var J,G;J={model:I,collection:this.collection,disable:!this.isEditable};this.views[I.cid]=G=new a.Fields.EmbeddedItemView(J,this);this.body.append(G.render().el);if(H!=null?H.focus:void 0){j(function(){return G.focus()})}if(!this.focusable){this.focusable=G}this.update();return this};E.prototype.removeItem=function(H){var G;if(G=this.views[H.cid]){G.remove();delete this.views[H.cid]}this.update();return this};E.prototype.render=function(){var H,J,G,I;this.dispose();this.$el.html(this.template());this.body=this.$component("body");this.createButton=this.$(".btn-create");I=this.collection.models;for(J=0,G=I.length;J<G;J++){H=I[J];this.add(H)}return E.__super__.render.apply(this,arguments)};E.prototype.update=function(){this.createButton.toggle(this.field.isMultiple()||this.collection.hasSpots());return this};E.prototype.template=function(){var G;G=this.canCreate()?D("","plus",["default","create"]):"";return"<div class='header field-label'>\n    "+(this.helpTemplate())+(_.escape(this.field.getLabel()))+" "+G+'\n</div>\n<div class="error-container has-error">'+(this.errorTemplate())+'</div>\n<div class="body" id="'+(this.componentId("body"))+'"></div>'};E.prototype.canCreate=function(){return this.isEditable&&this.field.getReferencedEntity().createPermitted()};E.prototype.dispose=function(){var I,G,H;H=this.views;for(I in H){G=H[I];G.remove()}this.views={};this.focusable=null;return this};E.prototype.remove=function(){this.dispose();return E.__super__.remove.apply(this,arguments)};E.prototype.isFocusable=function(){if(!E.__super__.isFocusable.apply(this,arguments)){return false}return(this.field.isMultiple()&&this.canCreate())||(!this.field.isMultiple()&&(this.focusable!=null))};E.prototype.focus=function(){var H,G;if(this.field.isMultiple()){if((H=this.createButton[0])!=null){H.focus()}}else{if((G=this.focusable)!=null){G.focus()}}return this};return E})(a.Fields.BaseView);a.Fields.EmbeddedItemView=(function(F){A(E,F);E.prototype.className="has-many-item-view";E.prototype.events={"click .btn-toggle":"toggleItem"};function E(G){this.collection=G.collection;this.listenTo(this.collection,"restore removeSoftly",function(H){if(H!==this.model){return}this.$container.toggle(!this.model.isDeleted);return this.$btn.html(this.buttonContents())});E.__super__.constructor.apply(this,arguments)}E.prototype.toggleItem=function(G){if(this.model.isDeleted){this.collection.restore(this.model)}else{this.collection.removeSoftly(this.model)}return false};E.prototype.buttonContents=function(){if(this.model.isDeleted){return a.lang.restore}else{return i("trash")+" "+a.lang["delete"]}};E.prototype.setupDefaultLayout=function(){this.append(new b({},this));return this};E.prototype.render=function(){this.$el.html(this.template());this.$container=this.$component("body");this.$btn=this.$component("btn");return E.__super__.render.apply(this,arguments)};E.prototype.template=function(){var G;G='<div id="'+(this.componentId("body"))+'"></div>';if(!this.disabled&&(this.model.entity.deletePermitted()||this.model.isNew())){G+='<button type="button" class="btn btn-default btn-sm btn-toggle" id="'+(this.componentId("btn"))+'">\n    '+(this.buttonContents())+"\n</button>"}return G};return E})(a.Layout.Layout);a.Fields.RelatedCollection=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G,H){this.entity=H.entity;this.owner=H.owner;this.field=H.field;this.maxItems=H.maxItems;this.deleted=false;this.removedSoftly=0;this.listenTo(this.owner,"sync",function(J,K,I){this.deleted=false;return this._triggerItems("sync",{},I)});this.listenTo(this.owner,"request",function(J,K,I){return this._triggerItems("request",K,I)});this.listenTo(this.owner,"invalid",this._handleInvalidEvent);return E.__super__.initialize.apply(this,arguments)};E.prototype._handleInvalidEvent=function(G,L){var K,H,J,I;if(!(this.field.id in L)){return}I=L[this.field.id];for(K in I){J=I[K];if(H=this.get(K)){H.trigger("invalid",H,J)}}};E.prototype._triggerItems=function(I,M,L){var H,K,G,J;J=this.models;for(K=0,G=J.length;K<G;K++){H=J[K];H.trigger(I,H,M,L)}};E.prototype.add=function(){if(this.maxItems&&this.models.length>=this.maxItems){this.removeSoftDeleted()}return E.__super__.add.apply(this,arguments)};E.prototype.removeSoftDeleted=function(){return this.remove(this.filter(function(G){return G.isDeleted}))};E.prototype.remove=function(J){var H,I,G;this.deleted=true;if(_.isArray(J)){for(I=0,G=J.length;I<G;I++){H=J[I];if(H.isDeleted){this.removedSoftly--}}}else{if(modes.isDeleted){this.removedSoftly--}}return E.__super__.remove.apply(this,arguments)};E.prototype.removeSoftly=function(G){if(G.isDeleted){return}G.isDeleted=true;this.removedSoftly++;this.trigger("removeSoftly",G);return this};E.prototype.restore=function(G){if(!G.isDeleted){return}G.isDeleted=false;this.removedSoftly--;this.trigger("restore",G);return this};E.prototype.hasSpots=function(G){if(G==null){G=1}return(this.maxItems==null)||this.models.length-this.removedSoftly+G<=this.maxItems};E.prototype.hasChangedSinceSync=function(){var H,J,G,I;if(this.deleted||this.removedSoftly){return true}I=this.models;for(J=0,G=I.length;J<G;J++){H=I[J];if(H.hasChangedSinceSync()){return true}}return false};E.prototype.copy=function(I){var H,G;G=this.field.isUnique()?[]:(function(){var M,K,L,J;L=this.models;J=[];for(M=0,K=L.length;M<K;M++){H=L[M];J.push(H.copy())}return J}).call(this);return new a.Fields.RelatedCollection(G,{owner:I,field:this.field})};E.prototype.serialize=function(){var J,H,K,I,G;K=this.filter(function(L){return L.canBeSaved()});J={};for(I=0,G=K.length;I<G;I++){H=K[I];J[H.cid]=H.serialize()}return J};E.prototype.modelId=function(){return this.entity.getPrimaryKey()};return E})(Backbone.Collection);a.Fields.Embedded=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.viewConstructor=a.Fields.EmbeddedView;E.prototype.parse=function(H,G){var K,J,I;if(G instanceof a.Fields.RelatedCollection){return G}if(G&&!_.isArray(G)){G=[G]}G=G||[];if(_.isEmpty(G)&&this.isRequired(H)){G.push({})}I=this.getReferencedEntity();G=(function(){var N,M,L;L=[];for(N=0,M=G.length;N<M;N++){J=G[N];L.push(I.createInstance(J))}return L})();if(K=H.get(this.id)){K.reset(G);return K}return new a.Fields.RelatedCollection(G,{entity:I,owner:H,field:this,maxItems:this.isMultiple()?null:1})};E.prototype.hasChangedSinceSync=function(G){return G.get(this.id).hasChangedSinceSync()};E.prototype.copy=function(H,G){return G.copy(H)};E.prototype.isMultiple=function(){return this.attributes.multiple};E.prototype.copyAttribute=function(G,H){return G.get(this.id).copy(H)};E.prototype.prepareAttribute=function(G){if(G){return G.serialize()}else{return null}};E.prototype.isCopyable=function(){return true};E.prototype.getType=function(){return"inline-relation"};return E})(a.Fields.BaseRelation);a.Fields.Number=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.createFilterInput=function(G){return new a.Inputs.NumberFilter({model:G,key:this.id})};E.prototype.prepareFilterData=function(G){if(_.isEmpty(G.val)){return null}return(G.op==="="?"":G.op)+G.val};E.prototype.parseFilterData=function(G){var I,H;I=">";H=null;if(_.isString(G)&&G.length){I=G[0];if(I==="="||I==="<"||I===">"){H=G.substr(1)}else{I="=";H=G}}else{if(_.isNumber(G)){I="=";H=G}}return{op:I,val:H}};E.prototype.getType=function(){return"number"};return E})(a.Fields.Input);a.Fields.Computed=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.createInput=function(G){return new a.Inputs.Static({model:G,key:this.id,formatter:this})};F.prototype.isEditable=function(){return false};F.prototype.getType=function(){return"computed"};return F})(a.Fields.Base);a.Columns.Base=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G){if(G.formatter!=null){this.formatter=a.formatters.create(G.formatter,G.formatter_options)}return E.__super__.initialize.apply(this,arguments)};E.prototype.render=function(G){return this.format(G.attributes[this.id])};E.prototype.format=function(G){if(this.formatter!=null){return this.formatter.format(G)}else{return _.escape(G)}};E.prototype.getHeader=function(){return this.attributes.header};E.prototype.getClass=function(){return"col-"+this.id+(this.canOrder()?" col__sortable":"")};E.prototype.canOrder=function(){return this.attributes.can_order};return E})(a.Attribute);a.Columns.Proxy=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.initialize=function(G){var I,H;I=(H=G.field)!=null?H:G.id;this.field=G.entity.fields.get(I);return F.__super__.initialize.apply(this,arguments)};F.prototype.format=function(G){if(this.formatter!=null){return this.formatter.format(G)}else{return this.field.format(G)}};F.prototype.getClass=function(){return F.__super__.getClass.apply(this,arguments)+" col__"+this.field.getType()};return F})(a.Columns.Base);a.Columns.Computed=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.getClass=function(){return F.__super__.getClass.apply(this,arguments)+" col__computed"};return F})(a.Columns.Base);a.Columns.ViewButton=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.id="__viewButton";E.prototype.getHeader=function(){return""};E.prototype.getClass=function(){return"col__view-button col__auto-hide"};E.prototype.canOrder=function(){return false};E.prototype.render=function(G){return this.wrapWithActions(G,"<a onclick=\"Cruddy.app.entityView.displayForm('"+G.meta.id+'\', this);return false;" class="btn btn-default btn-view btn-xs auto-hide-target" href="'+(this.entity.link(G.meta.id))+'">\n    '+(i("pencil"))+"\n</a>")};E.prototype.wrapWithActions=function(H,G){if(_.isEmpty(H.meta.links)&&_.isEmpty(H.meta.actions)){return G}G='<div class="btn-group btn-group-xs auto-hide-target">'+G;G+=this.dropdownToggleTemplate();G+=this.renderActions(H);G+="</div>";return G};E.prototype.dropdownToggleTemplate=function(){return'<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">\n    <span class="caret"></span>\n</button>'};E.prototype.renderActions=function(H){var M,I,J,L,G,K;I='<ul class="dropdown-menu" role="menu">';if(!(J=_.isEmpty(H.meta.links))){I+=m(H.meta.links)}if(!_.isEmpty(H.meta.actions)){if(!J){I+=n()}K=H.meta.actions;for(L=0,G=K.length;L<G;L++){M=K[L];I+=this.renderAction(M,H)}}I+="</ul>";return I};E.prototype.renderAction=function(H,G){return'<li class="'+(H.disabled?"disabled":"")+'">\n    <a onclick="Cruddy.app.entityView.executeCustomAction(\''+H.id+"', '"+G.meta.id+'\', this);return false;" href="javascript:void;">\n        '+(_.escape(H.title))+"\n    </a>\n</li>"};return E})(a.Columns.Base);a.Columns.DeleteButton=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.id="__deleteButton";F.prototype.getHeader=function(){return""};F.prototype.getClass=function(){return"col__delete-button col__button col__auto-hide"};F.prototype.canOrder=function(){return false};F.prototype.render=function(G){return'<a href="#" data-action="deleteItem" class="btn btn-default btn-xs auto-hide-target">\n    '+(i("trash"))+"\n</a>"};return F})(a.Columns.Base);a.Filters.Base=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.getLabel=function(){return this.attributes.label};E.prototype.getClass=function(){return"filter filter__"+this.attributes.type+" filter--"+this.id};E.prototype.createFilterInput=function(){throw"Implement required"};E.prototype.prepareData=function(G){return G};E.prototype.parseData=function(G){return G};E.prototype.getDataKey=function(){return this.get("data_key")||this.id};return E})(a.Attribute);a.Filters.Proxy=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.initialize=function(G){var I,H;I=(H=G.field)!=null?H:G.id;this.field=G.entity.fields.get(I);return F.__super__.initialize.apply(this,arguments)};F.prototype.createFilterInput=function(G){return this.field.createFilterInput(G)};F.prototype.prepareData=function(G){return this.field.prepareFilterData(G)};F.prototype.parseData=function(G){return this.field.parseFilterData(G)};return F})(a.Filters.Base);r=(function(){E.prototype.defaultOptions={};function E(F){if(F==null){F={}}this.options=$.extend({},this.defaultOptions,F);this}E.prototype.format=function(F){return F};return E})();a.formatters.Image=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.defaultOptions={width:40,height:40};E.prototype.format=function(G){if(_.isEmpty(G)){return""}if(_.isArray(G)){G=G[0]}if(_.isObject(G)){G=G.title}return'<a href="'+(a.root+"/"+G)+'" data-trigger="fancybox">\n    <img src="'+(u(G,this.options.width,this.options.height))+'" '+(this.options.width?" width="+this.options.width:"")+" "+(this.options.height?" height="+this.options.height:"")+' alt="'+(_.escape(G))+'">\n</a>'};return E})(r);a.formatters.Plain=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.format=function(G){return G};return F})(r);a.Entity={};a.Entity.Entity=(function(E){A(F,E);function F(){return F.__super__.constructor.apply(this,arguments)}F.prototype.initialize=function(G,H){this.fields=this.createObjects(G.fields);this.columns=this.createObjects(G.columns);this.filters=this.createObjects(G.filters);this.permissions=a.permissions[this.id];this.cache={};return this};F.prototype.createObjects=function(H){var J,L,I,K,G;L=[];for(K=0,G=H.length;K<G;K++){I=H[K];I.entity=this;J=y(I["class"]);if(!J){throw"The class "+I["class"]+" is not found"}L.push(new J(I))}return new Backbone.Collection(L)};F.prototype.createDataSource=function(H){var G,I;I={order_by:this.get("order_by")};if(G=this.columns.get(I.order_by)){I.order_dir=G.get("order_dir")}H=$.extend({},I,H);return new d(H,{entity:this})};F.prototype.getDataSource=function(){if(!this.dataSource){this.dataSource=this.createDataSource()}return this.dataSource};F.prototype.createFilters=function(H){var G,I;if(H==null){H=this.columns}I=(function(){var M,K,L,J;L=H.models;J=[];for(M=0,K=L.length;M<K;M++){G=L[M];if(G.get("filter_type")==="complex"){J.push(G.createFilter())}}return J})();return new Backbone.Collection(I)};F.prototype.createInstance=function(J,I){var H,G;if(J==null){J={}}if(I==null){I={}}I.entity=this;H=_.extend({},this.get("defaults"),J.attributes);G=new a.Entity.Instance(H,I);return G.setMetaFromResponse(J)};F.prototype.field=function(H){var G;if(!(G=this.fields.get(H))){console.error("The field "+H+" is not found.");return}return G};F.prototype.getField=function(G){return this.fields.get(G)};F.prototype.search=function(G){if(G==null){G={}}return new w({},$.extend({url:this.url()},G))};F.prototype.load=function(J,G){var H,I;H={cached:true};G=$.extend(H,G);if(G.cached&&J in this.cache){return $.Deferred().resolve(this.cache[J]).promise()}I=$.ajax({url:this.url(J),type:"GET",dataType:"json",displayLoading:true});I=I.then((function(K){return function(M){var L;L=K.createInstance(M);K.cache[L.id]=L;return L}})(this));return I};F.prototype.destroy=function(H,G){if(G==null){G={}}G.url=this.url(H);G.type="POST";G.dataType="json";G.data={_method:"DELETE"};G.displayLoading=true;return $.ajax(G)};F.prototype.executeAction=function(I,H,G){if(G==null){G={}}G.url=this.url(I+"/"+H);G.type="POST";G.dataType="json";G.displayLoading=true;return $.ajax(G)};F.prototype.getCopyableAttributes=function(H,M){var K,L,J,G,I;K={};I=this.fields.models;for(J=0,G=I.length;J<G;J++){L=I[J];if(L.isCopyable()){K[L.id]=L.copyAttribute(H,M)}}return K};F.prototype.hasChangedSinceSync=function(H){var K,J,G,I;I=this.fields.models;for(J=0,G=I.length;J<G;J++){K=I[J];if(K.hasChangedSinceSync(H)){return true}}};F.prototype.prepareAttributes=function(H,I){var L,J,G,K;G={};for(J in H){K=H[J];if(L=this.getField(J)){G[J]=L.prepareAttribute(K)}}return G};F.prototype.url=function(G){return s(this.id,G)};F.prototype.link=function(H){var G;G=this.url();if(H instanceof a.Entity.Instance){H=H.id}if(H){return G+"?id="+H}else{return G}};F.prototype.createController=function(){var G;G=y(this.attributes.controller_class)||a.Entity.Page;if(!G){throw"Failed to resolve page class "+this.attributes.view}return new G({model:this})};F.prototype.getPluralTitle=function(){return this.attributes.title.plural};F.prototype.getSingularTitle=function(){return this.attributes.title.singular};F.prototype.getPermissions=function(){return this.permissions};F.prototype.readPermitted=function(){return this.permissions.read};F.prototype.updatePermitted=function(){return this.permissions.update};F.prototype.createPermitted=function(){return this.permissions.create};F.prototype.deletePermitted=function(){return this.permissions["delete"]};F.prototype.isSoftDeleting=function(){return this.attributes.soft_deleting};F.prototype.getPrimaryKey=function(){return this.attributes.primary_key||"id"};return F})(Backbone.Model);a.Entity.Instance=(function(F){A(E,F);function E(G,H){this.entity=H.entity;this.idAttribute=this.entity.getPrimaryKey();this.meta={};E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G,H){this.syncOriginalAttributes();this.on("error",this.handleErrorEvent,this);this.on("sync",this.handleSyncEvent,this);this.on("destroy",this.handleDestroyEvent,this);return this};E.prototype.syncOriginalAttributes=function(){this.original=_.clone(this.attributes);this.primaryKey=this.id;return this};E.prototype.handleSyncEvent=function(G,H){this.syncOriginalAttributes();this.setMetaFromResponse(H);return this};E.prototype.setMetaFromResponse=function(G){if(G.meta!=null){this.meta=_.clone(G.meta)}return this};E.prototype.handleErrorEvent=function(G,H){if(H.status===x){this.trigger("invalid",this,H.responseJSON)}};E.prototype.handleDestroyEvent=function(G){this.isDeleted=true};E.prototype.validate=function(){this.set("errors",{});return null};E.prototype.link=function(){return this.entity.link(this.primaryKey||"create")};E.prototype.url=function(){return this.entity.url(this.primaryKey)};E.prototype.set=function(H,L,G){var I,K,J;if(_.isObject(H)){for(I in H){J=H[I];if(K=this.entity.getField(I)){H[I]=K.parse(this,J)}}}return E.__super__.set.apply(this,arguments)};E.prototype.sync=function(J,H,G){var I;if(J==="update"||J==="create"){G.data=new f(this.entity.prepareAttributes((I=G.attrs)!=null?I:this.attributes,this)).original;G.contentType=false;G.processData=false}return E.__super__.sync.apply(this,arguments)};E.prototype.parse=function(G){return G.attributes};E.prototype.copy=function(){var G;G=this.entity.createInstance();G.set(this.entity.getCopyableAttributes(this,G),{silent:true});return G};E.prototype.hasChangedSinceSync=function(){return this.entity.hasChangedSinceSync(this)};E.prototype.canBeSaved=function(){var G;G=this.isNew();return((G&&this.entity.createPermitted())||(!G&&this.entity.updatePermitted()))&&(!this.isDeleted||!G)};E.prototype.serialize=function(){var G;G=this.isDeleted?{}:this.entity.prepareAttributes(this.attributes,this);return $.extend(G,{__id:this.id,__d:this.isDeleted})};E.prototype.action=function(){if(this.isNew()){return"create"}else{return"update"}};E.prototype.getTitle=function(){if(this.isNew()){return a.lang.model_new_record}else{return this.meta.title}};E.prototype.getOriginal=function(G){return this.original[G]};E.prototype.isNew=function(){return !this.primaryKey};return E})(Backbone.Model);a.Entity.Page=(function(F){A(E,F);E.prototype.className="page entity-page";E.prototype.events={"click .ep-btn-create":"create","click .ep-btn-refresh":"refreshData"};function E(G){this.className+=" entity-page-"+G.model.id;E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G){this.dataSource=this._setupDataSource();j((function(H){return function(){return H.listenTo(a.router,"route:index",H._updateFromQuery)}})(this));return E.__super__.initialize.apply(this,arguments)};E.prototype._updateFromQuery=function(){this._updateDataSourceFromQuery();this._displayForm().fail((function(G){return function(){return G._updateModelIdInQuery({replace:true})}})(this));return this};E.prototype._setupDataSource=function(){var G;this.dataSource=G=this.model.getDataSource();this._updateFromQuery();if(!(G.inProgress()||G.hasData())){G.fetch()}this.listenTo(G,"change",this._refreshQuery);return G};E.prototype._refreshQuery=function(){var G;G=this.dataSource;a.router.refreshQuery(G.attributes,G.defaults,{trigger:false});return this};E.prototype._updateDataSourceFromQuery=function(G){var I,H;I=$.extend({},this.dataSource.defaults,_.omit(a.router.query.keys,["id"]));for(H in this.dataSource.attributes){if(!(H in I)){I[H]=null}}this.dataSource.set(I,G)};E.prototype._updateModelIdInQuery=function(H){var G;G=a.router;H=$.extend({trigger:false,replace:false},H);if(this.form){G.setQuery("id",this.form.model.primaryKey||"new",H)}else{G.removeQuery("id",H)}return this};E.prototype._displayForm=function(J){var I,H,G,L,K;if(this.loadingForm){return this.loadingForm}J=J!=null?J:a.router.getQuery("id");if(J instanceof a.Entity.Instance){G=J;J=G.id||"new"}this.loadingForm=H=$.Deferred();this.loadingForm.always((function(M){return function(){return M.loadingForm=null}})(this));if(this.form){I=this.form.model.isNew()?"new":this.form.model.id;if(J===I||!this.form.confirmClose()){H.reject();return H.promise()}}L=(function(M){return function(N){M._createAndRenderForm(N);return H.resolve(N)}})(this);if(J==="new"&&!G){G=this.model.createInstance()}if(G){L(G);return H.promise()}if(J){this.model.load(J).done(L).fail(function(){return H.reject()})}else{if((K=this.form)!=null){K.remove()}H.resolve()}return H.promise()};E.prototype._createAndRenderForm=function(G){var H,I;if((I=this.form)!=null){I.remove()}this.form=H=a.Entity.Form.display(G);H.on("close",(function(J){return function(){return a.router.removeQuery("id",{trigger:false})}})(this));H.on("created",function(J){return a.router.setQuery("id",J.id)});H.on("remove",(function(J){return function(){J.form=null;J.model.set("instance",null);return J.stopListening(G)}})(this));H.on("saved",(function(J){return function(){J.dataSource.fetch();return J._updateModelIdInQuery({replace:true})}})(this));H.on("saved remove",function(){return a.app.updateTitle()});this.model.set("instance",G);a.app.updateTitle();return this};E.prototype.displayForm=function(G){return this._displayForm(G).done((function(H){return function(){return H._updateModelIdInQuery()}})(this))};E.prototype.create=function(){this.displayForm("new");return this};E.prototype.refreshData=function(H){var G;G=$(H.currentTarget);G.prop("disabled",true);this.dataSource.fetch().always(function(){return G.prop("disabled",false)});return this};E.prototype.render=function(){this.$el.html(this.template());this.searchInputView=this.createSearchInputView();this.dataView=this.createDataView();this.paginationView=this.createPaginationView();this.filterListView=this.createFilterListView();if(this.searchInputView){this.$component("search_input_view").append(this.searchInputView.render().$el)}if(this.filterListView){this.$component("filter_list_view").append(this.filterListView.render().el)}if(this.dataView){this.$component("data_view").append(this.dataView.render().el)}if(this.paginationView){this.$component("pagination_view").append(this.paginationView.render().el)}return this};E.prototype.createDataView=function(){return new p({model:this.dataSource,entity:this.model})};E.prototype.createPaginationView=function(){return new c({model:this.dataSource})};E.prototype.createFilterListView=function(){var G;if((G=this.dataSource.entity.filters).isEmpty()){return}return new g({model:this.dataSource,entity:this.model,filters:G})};E.prototype.createSearchInputView=function(){return new a.Inputs.Search({model:this.dataSource,key:"keywords"})};E.prototype.template=function(){return'<div class="content-header">\n    <div class="column column-main">\n        <h1 class="entity-title">'+(this.model.getPluralTitle())+'</h1>\n\n        <div class="entity-title-buttons">\n            '+(this.buttonsTemplate())+'\n        </div>\n    </div>\n\n    <div class="column column-extra">\n        <div class="entity-search-box" id="'+(this.componentId("search_input_view"))+'"></div>\n    </div>\n</div>\n\n<div class="content-body">\n    <div class="column column-main">\n        <div id="'+(this.componentId("data_view"))+'"></div>\n        <div id="'+(this.componentId("pagination_view"))+'"></div>\n    </div>\n\n    <div class="column column-extra" id="'+(this.componentId("filter_list_view"))+'"></div>\n</div>'};E.prototype.buttonsTemplate=function(){var G;G='<button type="button" class="btn btn-default ep-btn-refresh" title="'+a.lang.refresh+'">\n    '+(i("refresh"))+"\n</button>";G+=" ";if(this.model.createPermitted()){G+='<button type="button" class="btn btn-primary ep-btn-create" title="'+a.lang.add+'">\n    '+(i("plus"))+"\n</button>"}return G};E.prototype.remove=function(){var H,G,K,J,I;if((H=this.form)!=null){H.remove()}if((G=this.filterListView)!=null){G.remove()}if((K=this.dataView)!=null){K.remove()}if((J=this.paginationView)!=null){J.remove()}if((I=this.searchInputView)!=null){I.remove()}return E.__super__.remove.apply(this,arguments)};E.prototype.getPageTitle=function(){var G;G=this.model.getPluralTitle();if(this.form!=null){G=this.form.model.getTitle()+l+G}return G};E.prototype.executeCustomAction=function(I,H,G){if(G&&!$(G).parent().is("disabled")){this.model.executeAction(H,I,{success:(function(J){return function(){return J.dataSource.fetch()}})(this)})}return this};E.prototype.pageUnloadConfirmationMessage=function(){var G;return(G=this.form)!=null?G.pageUnloadConfirmationMessage():void 0};return E})(a.View);a.Entity.Form=(function(F){A(E,F);E.prototype.className="entity-form";E.prototype.events={"click [data-action]":"executeAction"};function E(G){this.className+=" "+this.className+"-"+G.model.entity.id;E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(G){E.__super__.initialize.apply(this,arguments);this.saveOptions={displayLoading:true,xhr:(function(H){return function(){var I;I=$.ajaxSettings.xhr();if(I.upload){I.upload.addEventListener("progress",$.proxy(H,"progressCallback"))}return I}})(this)};this.listenTo(this.model,"destroy",this.handleModelDestroyEvent);this.listenTo(this.model,"invalid",this.handleModelInvalidEvent);this.hotkeys=$(document).on("keydown."+this.cid,"body",$.proxy(this,"hotkeys"));return this};E.prototype.setupDefaultLayout=function(){var K,H,J,G,I;H=this.append(new a.Layout.TabPane({title:this.model.entity.get("title").singular},this));I=this.entity.fields.models;for(J=0,G=I.length;J<G;J++){K=I[J];H.append(new a.Layout.Field({field:K.id},H))}return this};E.prototype.hotkeys=function(G){if(G.ctrlKey&&G.keyCode===90&&G.target===document.body){this.model.set(this.model.previousAttributes());return false}if(G.ctrlKey&&G.keyCode===13){this.saveModel();return false}if(G.keyCode===27){this.closeForm();G.preventDefault();return false}return this};E.prototype.displayAlert=function(H,G,I){if(this.alert!=null){this.alert.remove()}this.alert=new h({message:H,className:"flash",type:G,timeout:I});this.$footer.prepend(this.alert.render().el);return this};E.prototype.displaySuccess=function(){return this.displayAlert(a.lang.success,"success",3000)};E.prototype.displayError=function(G){if(G.status!==x){return this.displayAlert(a.lang.failure,"danger",5000)}};E.prototype.handleModelInvalidEvent=function(){return this.displayAlert(a.lang.invalid,"warning",5000)};E.prototype.handleModelDestroyEvent=function(){this.updateModelState();this.trigger("destroyed",this.model);return this};E.prototype.show=function(){this.$el.toggleClass("opened",true);this.items[0].activate();this.focus();return this};E.prototype.save=function(H){var G;if(this.request!=null){return}G=this.model.isNew();this.setupRequest(this.model.save(null,$.extend({},this.saveOptions,H)));this.request.done((function(I){return function(J){I.trigger((G?"created":"updated"),I.model,J);I.trigger("saved",I.model,J);return I.updateModelState()}})(this));return this};E.prototype.saveModel=function(){return this.save()};E.prototype.saveWithAction=function(G){return this.save({url:this.model.entity.url(this.model.id+"/"+G.data("actionId"))})};E.prototype.destroyModel=function(){var H,G;if(this.request||this.model.isNew()){return}G=this.model.entity.get("soft_deleting");H=!G?confirm(a.lang.confirm_delete):true;if(H){this.request=this.softDeleting&&this.model.get("deleted_at")?this.model.restore:this.model.destroy({wait:true});this.request.always((function(I){return function(){return I.request=null}})(this))}return this};E.prototype.copyModel=function(){a.app.entityView.displayForm(this.model.copy());return this};E.prototype.refreshModel=function(){if(this.request!=null){return}if(this.confirmClose()){this.setupRequest(this.model.fetch())}this.request.done((function(G){return function(){return G.updateModelMetaState()}})(this));return this};E.prototype.setupRequest=function(G){G.done($.proxy(this,"displaySuccess")).fail($.proxy(this,"displayError"));G.always((function(H){return function(){H.request=null;return H.updateRequestState()}})(this));this.request=G;return this.updateRequestState()};E.prototype.progressCallback=function(H){var G;if(H.lengthComputable){G=(H.loaded*100)/H.total;this.$progressBar.width(G+"%").parent().show();if(G===100){this.$progressBar.parent().hide()}}return this};E.prototype.closeForm=function(){if(this.confirmClose()){this.remove();this.trigger("close")}return this};E.prototype.pageUnloadConfirmationMessage=function(){if(this.model.isDeleted){return}if(this.request){return a.lang.onclose_abort}if(this.model.hasChangedSinceSync()){return a.lang.onclose_discard}};E.prototype.confirmClose=function(){if(!this.model.isDeleted){if(this.request){return confirm(a.lang.confirm_abort)}if(this.model.hasChangedSinceSync()){return confirm(a.lang.confirm_discard)}}return true};E.prototype.render=function(){this.$el.html(this.template());this.$container=this.$component("body");this.$nav=this.$component("nav");this.$footer=this.$component("footer");this.$btnSave=this.$component("save");this.$deletedMsg=this.$component("deleted-message");this.$progressBar=this.$component("progress");this.$serviceMenu=this.$component("service-menu");this.$serviceMenuItems=this.$component("service-menu-items");this.updateModelState();return E.__super__.render.apply(this,arguments)};E.prototype.renderElement=function(G){this.$nav.append(G.getHeader().render().$el);return E.__super__.renderElement.apply(this,arguments)};E.prototype.updateRequestState=function(){var G;G=this.request!=null;this.$el.toggleClass("loading",G);this.$btnSave.attr("disabled",G);if(this.$btnExtraActions){this.$btnExtraActions.attr("disabled",G);this.$btnExtraActions.children(".btn").attr("disabled",G)}return this};E.prototype.updateModelState=function(){var H,I,G;H=this.model.entity;G=this.model.isNew();I=this.model.isDeleted||false;this.$el.toggleClass("destroyed",I);this.$btnSave.text(G?a.lang.create:a.lang.save);this.$btnSave.toggle(!I&&(G?H.createPermitted():H.updatePermitted()));return this.updateModelMetaState()};E.prototype.updateModelMetaState=function(){var I,H,G,J;G=this.model.isNew();H=this.model.isDeleted||false;this.$serviceMenu.toggle(!G);if(!G){this.$serviceMenuItems.html(this.renderServiceMenuItems())}if((J=this.$btnExtraActions)!=null){J.remove()}this.$btnExtraActions=null;if(this.model.entity.updatePermitted()){if(!G&&!H&&(I=this.renderExtraActionsButton())){this.$btnSave.before(this.$btnExtraActions=$(I))}}return this};E.prototype.template=function(){return'<div class="navbar navbar-default navbar-static-top" role="navigation">\n    <div class="container-fluid">\n        <ul id="'+(this.componentId("nav"))+'" class="nav navbar-nav"></ul>\n\n        <ul id="'+(this.componentId("service-menu"))+'" class="nav navbar-nav navbar-right">\n            <li class="dropdown">\n                <a class="dropdown-toggle" data-toggle="dropdown" href="#">\n                    <span class="glyphicon glyphicon-option-horizontal"></span>\n                </a>\n\n                <ul class="dropdown-menu" role="menu" id="'+(this.componentId("service-menu-items"))+'"></ul>\n            </li>\n        </ul>\n    </div>\n</div>\n\n<div class="tab-content" id="'+(this.componentId("body"))+'"></div>\n\n<footer id="'+(this.componentId("footer"))+'">\n    <span class="fs-deleted-message">'+a.lang.model_deleted+'</span>\n\n    <button data-action="closeForm" id="'+(this.componentId("close"))+'" type="button" class="btn btn-default">'+a.lang.close+'</button><!--\n    --><button data-action="saveModel" id="'+(this.componentId("save"))+'" type="button" class="btn btn-primary btn-save"></button>\n\n    <div class="progress">\n        <div id="'+(this.componentId("progress"))+'" class="progress-bar form-save-progress"></div>\n    </div>\n</footer>'};E.prototype.renderServiceMenuItems=function(){var H,K,J,G,I;H=(I=this.model).entity;K="";if(!((J=I.isDeleted)||_.isEmpty(G=I.meta.links))){K+=m(G);K+=n()}K+='<li class="'+(k(J,"disabled"))+'">\n    <a data-action="refreshModel" href="#">\n        '+a.lang.model_refresh+"\n    </a>\n</li>";K+='<li class="'+(k(!H.createPermitted(),"disabled"))+'">\n    <a data-action="copyModel" href="#">\n        '+a.lang.model_copy+"\n    </a>\n</li>";K+='<li class="divider"></li>\n\n<li class="'+(k(J||!H.deletePermitted(),"disabled"))+'">\n    <a data-action="destroyModel" href="#">\n        <span class="glyphicon glyphicon-trash"></span> '+a.lang.model_delete+"\n    </a>\n</li>";return K};E.prototype.renderExtraActionsButton=function(){var H,G;if(_.isEmpty(this.model.meta.actions)){return}G=_.find(this.model.meta.actions,function(I){return !I.disabled})||_.first(this.model.meta.actions);H='<button data-action="saveWithAction" data-action-id="'+G.id+'" type="button" class="btn btn-'+G.state+'" '+(k(G.isDisabled,"disabled"))+">\n    "+G.title+"\n</button>";return this.wrapWithExtraActions(H,G)};E.prototype.wrapWithExtraActions=function(J,H){var L,M,I,K,G;M=_.filter(this.model.meta.actions,function(N){return N!==H});if(_.isEmpty(M)){return J}I="";for(K=0,G=M.length;K<G;K++){L=M[K];I+='<li class="'+(k(L.disabled,"disabled"))+'">\n    <a data-action="saveWithAction" data-action-id="'+L.id+'" href="#">'+L.title+"</a>\n</li>"}return'<div class="btn-group dropup">\n    '+J+'\n\n    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">\n        <span class="caret"></span>\n    </button>\n\n    <ul class="dropdown-menu dropdown-menu-right" role="menu">\n        '+I+"\n    </ul>\n</div>"};E.prototype.remove=function(){this.trigger("remove",this);if(this.request){this.request.abort()}$(document).off("."+this.cid);this.$el.one(e,(function(G){return function(){G.trigger("removed",G);return E.__super__.remove.apply(G,arguments)}})(this));this.$el.removeClass("opened");return E.__super__.remove.apply(this,arguments)};E.prototype.executeAction=function(I){var G,H;if(I.isDefaultPrevented()){return}if((H=(G=$(I.currentTarget)).data("action"))&&H in this){I.preventDefault();this[H].call(this,G)}};return E})(a.Layout.Layout);a.Entity.Form.display=function(E){var F;F=new a.Entity.Form({model:E});$(document.body).append(F.render().$el);j((function(G){return function(){return F.show()}})(this));return F};t=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(){this.container=$("body");this.mainContent=$("#content");this.loadingRequests=0;this.entities={};this.dfd=$.Deferred();this.$title=$("title");this.$error=$(this.errorTemplate()).appendTo(this.container);this.$error.on("click",".close",(function(G){return function(){return G.$error.stop(true).fadeOut()}})(this));this.on("change:entity",this.displayEntity,this);$(document).ajaxError((function(G){return function(H,J,I){return G.handleAjaxError(J,I)}})(this));$(window).on("beforeunload",(function(G){return function(){return G.pageUnloadConfirmationMessage()}})(this));return this};E.prototype.errorTemplate=function(){return'<p class="alert alert-danger cruddy-global-error">\n    <button type="button" class="close">&times;</button>\n    <span class="data"></span>\n</p>'};E.prototype.init=function(){this._loadSchema();return this};E.prototype.ready=function(G){return this.dfd.done(G)};E.prototype._loadSchema=function(){var G;G=$.ajax({url:a.schemaUrl,displayLoading:true});G.done((function(H){return function(M){var K,J,L,I;for(L=0,I=M.length;L<I;L++){K=M[L];J=y(K.model_class)||a.Entity.Entity;H.entities[K.id]=new J(K)}H.dfd.resolve(H);$(document).trigger("started.cruddy",H)}})(this));G.fail((function(H){return function(){H.dfd.reject();H.displayError(a.lang.schema_failed)}})(this));return G};E.prototype.displayEntity=function(H,G){this.dispose();this.mainContent.hide();if(G){this.container.append((this.entityView=G.createController()).render().el)}return this.updateTitle()};E.prototype.displayError=function(G){this.dispose();this.mainContent.html("<p class='alert alert-danger'>"+G+"</p>").show();return this};E.prototype.handleAjaxError=function(I){var G,H;if(I.status===x){return}if((H=I.responseJSON)!=null?H.error:void 0){if(_.isObject(G=I.responseJSON.error)){G=G.type+": "+G.message}}else{G="Unknown error occurred"}this.$error.children(".data").text(G).end().stop(true).fadeIn()};E.prototype.pageUnloadConfirmationMessage=function(){var G;return(G=this.entityView)!=null?G.pageUnloadConfirmationMessage():void 0};E.prototype.startLoading=function(){if(this.loadingRequests++===0){this.loading=setTimeout(((function(G){return function(){$(document.body).addClass("loading");return G.loading=false}})(this)),1000)}return this};E.prototype.doneLoading=function(){if(this.loadingRequests===0){console.error("Seems like doneLoading is called too many times.");return}if(--this.loadingRequests===0){if(this.loading){clearTimeout(this.loading);this.loading=false}else{$(document.body).removeClass("loading")}}return this};E.prototype.entity=function(G){if(!(G in this.entities)){throw"Unknown entity "+G}return this.entities[G]};E.prototype.dispose=function(){var G;if((G=this.entityView)!=null){G.remove()}this.entityView=null;return this};E.prototype.updateTitle=function(){var G;G=a.brandName;if(this.entityView!=null){G=this.entityView.getPageTitle()+l+G}this.$title.text(G);return this};return E})(Backbone.Model);C=(function(F){A(E,F);function E(){return E.__super__.constructor.apply(this,arguments)}E.prototype.initialize=function(){var I,H,G;this.query=$.query;I=a.entities;this.addRoute("index",I);G=a.baseUrl;H=Backbone.history;$(document).on("click","a",(function(J){return function(P){var L,M,O,K,N;if(P.isDefaultPrevented()){return}L=P.currentTarget.href;if(L.indexOf(G)!==0){return}L=H.getFragment(L.slice(G.length));N=H.handlers;for(O=0,K=N.length;O<K;O++){M=N[O];if(!(M.route.test(L))){continue}P.preventDefault();H.navigate(L,{trigger:true});break}}})(this));return this};E.prototype.execute=function(){this.query=$.query.parseNew(location.search);return E.__super__.execute.apply(this,arguments)};E.prototype.navigate=function(G){this.query=this.query.load(G);return E.__super__.navigate.apply(this,arguments)};E.prototype.getQuery=function(G){return this.query.GET(G)};E.prototype.setQuery=function(H,I,G){return this.updateQuery(this.query.set(H,I),G)};E.prototype.refreshQuery=function(L,K,G){var H,J,I;if(K==null){K={}}J=this.query.copy();for(H in L){I=L[H];if(I===null||(H in K&&I===K[H])){J.REMOVE(H)}else{J.SET(H,I)}}return this.updateQuery(J,G)};E.prototype.removeQuery=function(H,G){return this.updateQuery(this.query.remove(H),G)};E.prototype.updateQuery=function(J,H){var K,G,I;if((G=J.toString())!==this.query.toString()){this.query=J;K=location.pathname;I="/"+a.uri+"/";if(K.indexOf(I)===0){K=K.slice(I.length)}Backbone.history.navigate(K+G,H)}return this};E.prototype.addRoute=function(H,J,I){var G;if(I==null){I=null}G="^("+J+")";if(I){G+="/"+I}G+="(\\?.*)?$";this.route(new RegExp(G),H);return this};E.prototype.resolveEntity=function(H,G){return a.ready(function(J){var I;I=J.entity(H);if(I.readPermitted()){a.app.set("entity",I);if(G){G.call(this,I)}}else{a.app.displayError(a.lang.entity_forbidden)}})};E.prototype.index=function(G){return this.resolveEntity(G)};return E})(Backbone.Router);$(function(){a.router=new C;return Backbone.history.start({root:a.uri_prefix+a.getHistoryRoot(),pushState:true,hashChange:false})});$(document).on("started.cruddy",function(G,H){var F,E;F=$(".navbar");E=function(I){var J;F.find(".navbar-nav li.active").removeClass("active");if(I==null){return}J=F.find(".navbar-nav [data-entity="+I.id+"]");J.addClass("active");return J.find(".badge").fadeOut()};H.on("change:entity",function(J,I){E(I)});E(H.get("entity"))})}).call(this);